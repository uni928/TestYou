<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ZIP â‡„ ç”»åƒ ã‚³ãƒ³ãƒãƒ¼ã‚¿</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --accent: #ffb347;
    --accent-strong: #ff8c42;
    --bg-gradient: radial-gradient(circle at top, #2a2a72, #000);
    --card-bg: rgba(20, 20, 35, 0.85);
    --border-color: rgba(255, 255, 255, 0.06);
    --text-main: #fdfdfd;
    --text-muted: #9ea5c7;
    --danger: #ff4b6e;
    --success: #53e88b;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    min-height: 100vh;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: var(--bg-gradient);
    color: var(--text-main);
    display: flex;
    align-items: stretch;
    justify-content: center;
    padding: 32px 16px;
  }

  .container {
    width: 100%;
    max-width: 1100px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .header {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
    align-items: center;
  }

  .title-block {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .title-block h1 {
    font-size: 1.7rem;
    margin: 0;
    letter-spacing: 0.04em;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .title-pill {
    padding: 2px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.18);
    background: linear-gradient(120deg, rgba(255,255,255,0.08), transparent);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-muted);
  }

  .subtitle {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-muted);
  }

  .mode-toggle {
    display: inline-flex;
    padding: 4px;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    background: rgba(5, 8, 25, 0.85);
    box-shadow: 0 18px 40px rgba(0,0,0,0.4);
    backdrop-filter: blur(18px);
  }

  .mode-button {
    position: relative;
    border: none;
    background: transparent;
    color: var(--text-muted);
    padding: 8px 14px 8px 12px;
    border-radius: 999px;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: color 140ms ease-out, transform 120ms ease-out;
  }

  .mode-button span.icon {
    font-size: 1rem;
  }

  .mode-button.active {
    color: var(--text-main);
  }

  .mode-button.active::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: radial-gradient(circle at top left, rgba(255,255,255,0.3), transparent 60%),
                linear-gradient(135deg, var(--accent), var(--accent-strong));
    z-index: -1;
  }

  .mode-button:not(.active):hover {
    color: #e5e7ff;
    transform: translateY(-1px);
  }

  .content {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
    gap: 20px;
  }

  @media (max-width: 900px) {
    .content {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .card {
    background: var(--card-bg);
    border-radius: 20px;
    border: 1px solid var(--border-color);
    box-shadow:
      0 24px 60px rgba(0,0,0,0.6),
      0 0 0 1px rgba(255,255,255,0.02) inset;
    padding: 18px 18px 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-header-main {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .card-title {
    margin: 0;
    font-size: 1.05rem;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.14);
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .card-description {
    margin: 0;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .dropzone {
    position: relative;
    margin-top: 4px;
    border-radius: 16px;
    border: 1px dashed rgba(255,255,255,0.18);
    background: radial-gradient(circle at top left, rgba(255,255,255,0.04), transparent 60%),
                rgba(10,15,35,0.9);
    padding: 18px 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    justify-content: center;
    align-items: center;
    text-align: center;
    cursor: pointer;
    transition: border-color 140ms ease-out, background 140ms ease-out, transform 120ms ease-out;
  }

  .dropzone:hover {
    border-color: rgba(255,255,255,0.36);
    transform: translateY(-1px);
  }

  .dropzone.dragover {
    border-color: var(--accent);
    background: radial-gradient(circle at top left, rgba(255,180,71,0.28), transparent 60%),
                rgba(10,15,35,0.95);
  }

  .dropzone-icon {
    width: 42px;
    height: 42px;
    border-radius: 12px;
    background: radial-gradient(circle at top, rgba(255,255,255,0.2), transparent 60%),
                linear-gradient(135deg, #303858, #171b33);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    box-shadow: 0 10px 20px rgba(0,0,0,0.6);
  }

  .dropzone-title {
    font-size: 0.9rem;
    font-weight: 500;
  }

  .dropzone-sub {
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .file-pill {
    margin-top: 4px;
    font-size: 0.78rem;
    color: var(--accent);
  }

  input[type="file"] {
    display: none;
  }

  .card-footer {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 8px;
    align-items: center;
  }

  .btn-main {
    border: none;
    border-radius: 999px;
    padding: 10px 18px;
    font-size: 0.9rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    background: linear-gradient(135deg, var(--accent), var(--accent-strong));
    color: #19151a;
    box-shadow:
      0 14px 30px rgba(0,0,0,0.7),
      0 0 0 1px rgba(0,0,0,0.6) inset;
    transition: transform 120ms ease-out, box-shadow 120ms ease-out, filter 120ms ease-out;
  }

  .btn-main:disabled {
    opacity: 0.5;
    cursor: default;
    box-shadow: none;
    transform: none;
    filter: grayscale(0.3);
  }

  .btn-main:not(:disabled):hover {
    transform: translateY(-1px);
    box-shadow:
      0 18px 40px rgba(0,0,0,0.9),
      0 0 0 1px rgba(0,0,0,0.5) inset;
    filter: brightness(1.02);
  }

  .btn-secondary {
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.18);
    background: transparent;
    color: var(--text-muted);
    font-size: 0.8rem;
    padding: 6px 12px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: background 120ms ease-out, color 120ms ease-out, border-color 120ms ease-out;
  }

  .btn-secondary:hover {
    background: rgba(255,255,255,0.06);
    color: var(--text-main);
    border-color: rgba(255,255,255,0.24);
  }

  .status-row {
    font-size: 0.78rem;
    color: var(--text-muted);
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.18);
  }

  .status-dot.ok {
    background: var(--success);
  }

  .status-dot.error {
    background: var(--danger);
  }

  .status-text {
    white-space: nowrap;
  }

  .preview-card {
    border-radius: 16px;
    border: 1px solid var(--border-color);
    background: radial-gradient(circle at top left, rgba(255,255,255,0.04), transparent 60%),
                rgba(10,15,30,0.9);
    padding: 12px 12px 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .preview-header {
    font-size: 0.82rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--text-muted);
  }

  .preview-img-wrapper {
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
    background: #050713;
    max-height: 320px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-img-wrapper img {
    max-width: 100%;
    max-height: 320px;
    display: block;
  }

  .meta-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .meta-badge {
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.02);
  }

  .link-like {
    font-size: 0.8rem;
    color: var(--accent);
    text-decoration: underline;
    cursor: pointer;
  }

  code.inline {
    font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.75rem;
    background: rgba(0,0,0,0.35);
    padding: 2px 5px;
    border-radius: 4px;
  }
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="title-block">
      <div class="title-pill">EXPERIMENTAL TOOL</div>
      <h1>ZIP â‡„ ç”»åƒ ã‚³ãƒ³ãƒãƒ¼ã‚¿</h1>
      <p class="subtitle">
        ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ=ç„¡ã—Base64 â†’ ãƒ”ã‚¯ã‚»ãƒ«ã€ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦PNGç”»åƒåŒ–ã—ã€å¾Œã‹ã‚‰å®Œå…¨ã«å…ƒã«æˆ»ã™ãŸã‚ã®ãƒ‡ãƒ¢ã§ã™ã€‚
      </p>
    </div>
    <div class="mode-toggle" aria-label="Mode toggle">
      <button class="mode-button active" data-mode="zip-to-img">
        <span class="icon">ğŸ“¦</span>
        ZIP â†’ ç”»åƒ
      </button>
      <button class="mode-button" data-mode="img-to-zip">
        <span class="icon">ğŸ–¼ï¸</span>
        ç”»åƒ â†’ ZIP
      </button>
    </div>
  </header>

  <main class="content">
    <!-- LEFT: Encoder / Decoder main panel -->
    <section class="card" id="left-card">
      <div class="card-header">
        <div class="dropzone-icon" id="mode-icon">ğŸ“¦</div>
        <div class="card-header-main">
          <h2 class="card-title" id="mode-title">
            ZIP â†’ ç”»åƒã¸ã®å¤‰æ›
            <span class="chip"><span>1px = 4æ–‡å­—</span></span>
          </h2>
          <p class="card-description" id="mode-desc">
            ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€Base64æ–‡å­—åˆ—ã‚’ãƒ”ã‚¯ã‚»ãƒ«ã«æ ¼ç´ã—ãŸPNGç”»åƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚
            æœ€åˆã®2ãƒ”ã‚¯ã‚»ãƒ«ã«ã€ŒBase64é•·ã€ã¨ã€Œ=ã®æ•°ã€ã‚’åŸ‹ã‚è¾¼ã‚“ã§ã„ã¾ã™ã€‚
          </p>
        </div>
      </div>

      <label class="dropzone" id="dropzone-zip" for="zip-input">
        <div class="dropzone-icon">â¬†ï¸</div>
        <div class="dropzone-title" id="dropzone-title-zip">ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <div class="dropzone-sub">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-pill" id="zip-file-name">é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        <input type="file" id="zip-input" accept=".zip,application/zip">
      </label>

      <label class="dropzone" id="dropzone-img" for="img-input" style="display:none;">
        <div class="dropzone-icon">â¬†ï¸</div>
        <div class="dropzone-title" id="dropzone-title-img">ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒ(PNG)ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <div class="dropzone-sub">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="file-pill" id="img-file-name">é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        <input type="file" id="img-input" accept="image/*">
      </label>

      <div class="card-footer">
        <button class="btn-main" id="action-button">
          <span id="action-icon">âœ¨</span>
          <span id="action-label">ç”»åƒã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
        </button>
        <div class="status-row">
          <div class="status-dot" id="status-dot"></div>
          <span class="status-text" id="status-text">å¾…æ©Ÿä¸­</span>
        </div>
      </div>

      <div class="preview-card">
        <div class="preview-header">
          <span id="preview-title">ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æƒ…å ±</span>
          <button class="btn-secondary" id="toggle-info">
            <span>ä»•æ§˜ãƒ¡ãƒ¢</span> <span>ğŸ“˜</span>
          </button>
        </div>
        <div id="info-block" style="font-size:0.78rem; color:var(--text-muted); line-height:1.6;">
          <div>ãƒ»Base64ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ: <code class="inline">Aâ€“Z aâ€“z 0â€“9 + /</code></div>
          <div>ãƒ»<code class="inline">=</code> ã¯æœ«å°¾ã‹ã‚‰å‰Šé™¤ â†’ å€‹æ•°(0ã€œ2)ã®ã¿åˆ¥ã«ä¿å­˜</div>
          <div>ãƒ»1ãƒ”ã‚¯ã‚»ãƒ«ç›®(R,G,B): Base64æ–‡å­—åˆ—é•·(24bit)</div>
          <div>ãƒ»2ãƒ”ã‚¯ã‚»ãƒ«ç›®(R): <code class="inline">=</code> ã®å€‹æ•°</div>
          <div>ãƒ»3ãƒ”ã‚¯ã‚»ãƒ«ç›®ä»¥é™ã¯ã€1pxã‚ãŸã‚Š4æ–‡å­—ã‚’æ¬¡ã®ãƒ«ãƒ¼ãƒ«ã§æ ¼ç´:</div>
          <div style="margin-left:10px;">
            R%64 â†’ 1æ–‡å­—ç›®, G%64 â†’ 2æ–‡å­—ç›®, B%64 â†’ 3æ–‡å­—ç›®<br>
            âŒŠR/64âŒ‹ãƒ»4ãƒ»4 + âŒŠG/64âŒ‹ãƒ»4 + âŒŠB/64âŒ‹ â†’ 4æ–‡å­—ç›®
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Preview / Result -->
    <section class="card">
      <div class="card-header">
        <div class="card-header-main">
          <h2 class="card-title">
            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            <span class="chip">çµæœè¡¨ç¤º</span>
          </h2>
          <p class="card-description">
            ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ™‚ã¯ç”Ÿæˆã•ã‚ŒãŸPNGã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒ‡ã‚³ãƒ¼ãƒ‰æ™‚ã¯å¾©å…ƒã•ã‚ŒãŸZIPã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
          </p>
        </div>
      </div>

      <div class="preview-card" id="preview-encoder">
        <div class="preview-header">
          <span>ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
          <span id="preview-meta-label" style="font-size:0.75rem; color:var(--text-muted);">ã¾ã ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</span>
        </div>
        <div class="preview-img-wrapper" id="preview-img-wrapper">
          <span style="font-size:0.8rem; color:var(--text-muted);">
            ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          </span>
        </div>
        <div class="meta-row" id="encoder-meta-row" style="display:none;">
          <span class="meta-badge" id="meta-size"></span>
          <span class="meta-badge" id="meta-dim"></span>
          <span class="meta-badge" id="meta-b64len"></span>
        </div>
      </div>

      <div class="preview-card" id="preview-decoder" style="display:none;">
        <div class="preview-header">
          <span>ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
          <span id="preview-zip-label" style="font-size:0.75rem; color:var(--text-muted);">ã¾ã å¾©å…ƒã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
        </div>
        <div style="font-size:0.8rem; color:var(--text-muted); line-height:1.6;">
          <div id="zip-download-area">
            ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒã‹ã‚‰ZIPã‚’å¾©å…ƒã™ã‚‹ã¨ã€ã“ã“ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </div>
          <div class="meta-row" id="decoder-meta-row" style="margin-top:8px; display:none;">
            <span class="meta-badge" id="meta-zip-size"></span>
            <span class="meta-badge" id="meta-b64len-dec"></span>
            <span class="meta-badge" id="meta-padding"></span>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<canvas id="work-canvas" style="display:none;"></canvas>

<script>
  // ===== Base64 ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const B64_CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

  function bytesToBase64(bytes) {
    let binary = "";
    const len = bytes.length;
    for (let i = 0; i < len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }

  function base64ToBytes(b64) {
    const binary = atob(b64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return bytes;
  }

  // ===== DOM å‚ç…§ =====
  const modeButtons = document.querySelectorAll(".mode-button");
  const modeTitle = document.getElementById("mode-title");
  const modeDesc = document.getElementById("mode-desc");
  const modeIcon = document.getElementById("mode-icon");

  const dropzoneZip = document.getElementById("dropzone-zip");
  const dropzoneImg = document.getElementById("dropzone-img");
  const zipInput = document.getElementById("zip-input");
  const imgInput = document.getElementById("img-input");
  const zipFileName = document.getElementById("zip-file-name");
  const imgFileName = document.getElementById("img-file-name");

  const actionButton = document.getElementById("action-button");
  const actionIcon = document.getElementById("action-icon");
  const actionLabel = document.getElementById("action-label");

  const statusDot = document.getElementById("status-dot");
  const statusText = document.getElementById("status-text");

  const previewEncoder = document.getElementById("preview-encoder");
  const previewDecoder = document.getElementById("preview-decoder");
  const previewImgWrapper = document.getElementById("preview-img-wrapper");
  const previewMetaLabel = document.getElementById("preview-meta-label");
  const metaSize = document.getElementById("meta-size");
  const metaDim = document.getElementById("meta-dim");
  const metaB64Len = document.getElementById("meta-b64len");
  const encoderMetaRow = document.getElementById("encoder-meta-row");

  const zipDownloadArea = document.getElementById("zip-download-area");
  const previewZipLabel = document.getElementById("preview-zip-label");
  const metaZipSize = document.getElementById("meta-zip-size");
  const metaB64LenDec = document.getElementById("meta-b64len-dec");
  const metaPadding = document.getElementById("meta-padding");
  const decoderMetaRow = document.getElementById("decoder-meta-row");

  const infoBlock = document.getElementById("info-block");
  const toggleInfo = document.getElementById("toggle-info");

  const workCanvas = document.getElementById("work-canvas");
  const ctx = workCanvas.getContext("2d");

  let currentMode = "zip-to-img";
  let selectedZipFile = null;
  let selectedImgFile = null;

  // ===== UI ãƒ˜ãƒ«ãƒ‘ =====
  function setStatus(text, type = "idle") {
    statusText.textContent = text;
    statusDot.classList.remove("ok", "error");
    if (type === "ok") statusDot.classList.add("ok");
    if (type === "error") statusDot.classList.add("error");
  }

  function formatBytes(bytes) {
    if (bytes === 0) return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    const value = bytes / Math.pow(k, i);
    return value.toFixed(value >= 10 ? 1 : 2) + " " + sizes[i];
  }

  // ===== ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ =====
  function updateModeUI() {
    if (currentMode === "zip-to-img") {
      modeIcon.textContent = "ğŸ“¦";
      modeTitle.innerHTML = `
        ZIP â†’ ç”»åƒã¸ã®å¤‰æ›
        <span class="chip"><span>1px = 4æ–‡å­—</span></span>
      `;
      modeDesc.textContent =
        "ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€Base64æ–‡å­—åˆ—ã‚’ãƒ”ã‚¯ã‚»ãƒ«ã«æ ¼ç´ã—ãŸPNGç”»åƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚æœ€åˆã®2ãƒ”ã‚¯ã‚»ãƒ«ã«ã€ŒBase64é•·ã€ã¨ã€Œ=ã®æ•°ã€ã‚’åŸ‹ã‚è¾¼ã‚“ã§ã„ã¾ã™ã€‚";

      dropzoneZip.style.display = "";
      dropzoneImg.style.display = "none";
      previewEncoder.style.display = "";
      previewDecoder.style.display = "none";

      actionIcon.textContent = "âœ¨";
      actionLabel.textContent = "ç”»åƒã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
      setStatus("ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
    } else {
      modeIcon.textContent = "ğŸ–¼ï¸";
      modeTitle.innerHTML = `
        ç”»åƒ â†’ ZIPã¸ã®å¾©å…ƒ
        <span class="chip"><span>ãƒ‡ã‚³ãƒ¼ãƒ‰</span></span>
      `;
      modeDesc.textContent =
        "ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿PNGç”»åƒã‹ã‚‰Base64æ–‡å­—åˆ—ã‚’å¾©å…ƒã—ã€ZIPãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚";

      dropzoneZip.style.display = "none";
      dropzoneImg.style.display = "";
      previewEncoder.style.display = "none";
      previewDecoder.style.display = "";

      actionIcon.textContent = "ğŸ”";
      actionLabel.textContent = "ZIPã«å¾©å…ƒã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
      setStatus("ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
    }
  }

  modeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const mode = btn.getAttribute("data-mode");
      if (mode === currentMode) return;
      currentMode = mode;
      modeButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      updateModeUI();
    });
  });

  updateModeUI();

  // ===== dropzone å…±é€šã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ =====
  function setupDropzone(dropzone, inputEl, onFileSelected) {
    ["dragenter", "dragover"].forEach(eventName => {
      dropzone.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add("dragover");
      });
    });
    ["dragleave", "drop"].forEach(eventName => {
      dropzone.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove("dragover");
      });
    });
    dropzone.addEventListener("drop", e => {
      const files = e.dataTransfer.files;
      if (files && files[0]) {
        onFileSelected(files[0]);
      }
    });
    inputEl.addEventListener("change", () => {
      if (inputEl.files && inputEl.files[0]) {
        onFileSelected(inputEl.files[0]);
      }
    });
  }

  // ===== ZIP â†’ IMG ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ =====
  setupDropzone(dropzoneZip, zipInput, file => {
    selectedZipFile = file;
    zipFileName.textContent = file.name + " (" + formatBytes(file.size) + ")";
    setStatus("ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿æº–å‚™OK", "ok");
  });

  // ===== IMG â†’ ZIP ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ =====
  setupDropzone(dropzoneImg, imgInput, file => {
    selectedImgFile = file;
    imgFileName.textContent = file.name + " (" + formatBytes(file.size) + ")";
    setStatus("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿æº–å‚™OK", "ok");
  });

  // ===== ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰: ZIP â†’ PNG =====
  async function encodeZipToImage() {
    if (!selectedZipFile) {
      alert("å…ˆã«ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    actionButton.disabled = true;
    setStatus("ZIPã‚’èª­ã¿è¾¼ã¿ä¸­â€¦");

    try {
      const arrayBuffer = await selectedZipFile.arrayBuffer();
      const bytes = new Uint8Array(arrayBuffer);

      setStatus("Base64ã«å¤‰æ›ä¸­â€¦");
      let b64 = bytesToBase64(bytes);

      // '=' ã‚’å‰Šé™¤ã—ã¦å€‹æ•°ã‚’æ•°ãˆã‚‹
      let paddingCount = 0;
      while (b64.endsWith("=")) {
        b64 = b64.slice(0, -1);
        paddingCount++;
      }

      const b64Length = b64.length;
      if (b64Length > 0xFFFFFF) {
        throw new Error("Base64é•·ãŒ 16,777,215 æ–‡å­—ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
      }

      // å¿…è¦ãªãƒ”ã‚¯ã‚»ãƒ«æ•°ã®ç®—å‡º (æœ€åˆã®2ãƒ”ã‚¯ã‚»ãƒ« + ãƒ‡ãƒ¼ã‚¿ãƒ”ã‚¯ã‚»ãƒ«)
      const dataPixels = Math.ceil(b64Length / 4);
      const totalPixels = 2 + dataPixels;

      const width = Math.ceil(Math.sqrt(totalPixels));
      const height = Math.ceil(totalPixels / width);

      workCanvas.width = width;
      workCanvas.height = height;

      const imageData = ctx.createImageData(width, height);
      const data = imageData.data;

      // 1ãƒ”ã‚¯ã‚»ãƒ«ç›®ã« Base64é•· (24bit) ã‚’ä¿å­˜
      // len = R<<16 | G<<8 | B
      const len = b64Length;
      data[0] = (len >> 16) & 0xFF; // R
      data[1] = (len >> 8) & 0xFF;  // G
      data[2] = len & 0xFF;         // B
      data[3] = 255;                // A

      // 2ãƒ”ã‚¯ã‚»ãƒ«ç›®ã« paddingCount ã‚’ä¿å­˜ (R)ã€ä»–ã¯0
      data[4] = paddingCount; // R
      data[5] = 0;            // G
      data[6] = 0;            // B
      data[7] = 255;          // A

      // 3ãƒ”ã‚¯ã‚»ãƒ«ç›®ä»¥é™: Base64æ–‡å­—åˆ—ã‚’4æ–‡å­—ãšã¤ãƒ”ã‚¯ã‚»ãƒ«ã«è©°ã‚ã‚‹
      // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 2ã€œtotalPixels-1
      let charIndex = 0;
      for (let p = 2; p < totalPixels; p++) {
        const offset = p * 4;

        const c1 = charIndex < b64Length ? B64_CHARS.indexOf(b64[charIndex++]) : 0;
        const c2 = charIndex < b64Length ? B64_CHARS.indexOf(b64[charIndex++]) : 0;
        const c3 = charIndex < b64Length ? B64_CHARS.indexOf(b64[charIndex++]) : 0;
        const c4 = charIndex < b64Length ? B64_CHARS.indexOf(b64[charIndex++]) : 0;

        if (c1 < 0 || c2 < 0 || c3 < 0 || c4 < 0) {
          throw new Error("Base64æ–‡å­—ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }

        // é€†å¤‰æ›:
        // c4 = rL*16 + gL*4 + bL  (rL,gL,bL: 0ã€œ3)
        const rL = Math.floor(c4 / 16);
        const gL = Math.floor((c4 % 16) / 4);
        const bL = c4 % 4;

        const R = rL * 64 + c1;
        const G = gL * 64 + c2;
        const B = bL * 64 + c3;

        data[offset + 0] = R;
        data[offset + 1] = G;
        data[offset + 2] = B;
        data[offset + 3] = 255;
      }

      // æ®‹ã‚Šã®æœªä½¿ç”¨ãƒ”ã‚¯ã‚»ãƒ«ãŒã‚ã‚Œã° 0 ã§åŸ‹ã‚ã‚‹
      for (let p = totalPixels; p < width * height; p++) {
        const offset = p * 4;
        data[offset + 0] = 0;
        data[offset + 1] = 0;
        data[offset + 2] = 0;
        data[offset + 3] = 255;
      }

      ctx.putImageData(imageData, 0, 0);

      setStatus("PNGç”»åƒã‚’ç”Ÿæˆä¸­â€¦");
      const dataURL = workCanvas.toDataURL("image/png");

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
      previewImgWrapper.innerHTML = "";
      const img = new Image();
      img.src = dataURL;
      previewImgWrapper.appendChild(img);
      previewMetaLabel.textContent = "ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã„ã¾ã™";
      encoderMetaRow.style.display = "flex";
      metaSize.textContent = "ZIP: " + formatBytes(bytes.length);
      metaDim.textContent = `ç”»åƒã‚µã‚¤ã‚º: ${width}Ã—${height}px`;
      metaB64Len.textContent = `Base64é•·: ${b64Length}æ–‡å­— (padding=${paddingCount})`;

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ç”Ÿæˆ
      const link = document.createElement("a");
      link.href = dataURL;
      const baseName = selectedZipFile.name.replace(/\.zip$/i, "");
      link.download = baseName + "_encoded.png";
      link.click();

      setStatus("ç”»åƒã®ç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚", "ok");
    } catch (err) {
      console.error(err);
      alert("ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
      setStatus("ã‚¨ãƒ©ãƒ¼: " + err.message, "error");
    } finally {
      actionButton.disabled = false;
    }
  }

  // ===== ãƒ‡ã‚³ãƒ¼ãƒ‰: PNG â†’ ZIP =====
  async function decodeImageToZip() {
    if (!selectedImgFile) {
      alert("å…ˆã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    actionButton.disabled = true;
    setStatus("ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­â€¦");

    try {
      const img = new Image();
      const objectURL = URL.createObjectURL(selectedImgFile);

      const imgLoaded = new Promise((resolve, reject) => {
        img.onload = () => resolve();
        img.onerror = e => reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"));
      });
      img.src = objectURL;
      await imgLoaded;

      workCanvas.width = img.width;
      workCanvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      const imageData = ctx.getImageData(0, 0, img.width, img.height);
      const data = imageData.data;

      // 1ãƒ”ã‚¯ã‚»ãƒ«ç›®ã‹ã‚‰ Base64é•· ã‚’å¾©å…ƒ
      const R0 = data[0];
      const G0 = data[1];
      const B0 = data[2];
      const len = (R0 << 16) | (G0 << 8) | B0;

      // 2ãƒ”ã‚¯ã‚»ãƒ«ç›®ã‹ã‚‰ paddingCount ã‚’å¾©å…ƒ
      const paddingCount = data[4];

      setStatus("Base64æ–‡å­—åˆ—ã‚’å¾©å…ƒä¸­â€¦");
      let charIndices = [];
      const totalPixels = img.width * img.height;

      for (let p = 2; p < totalPixels; p++) {
        if (charIndices.length >= len) break;
        const offset = p * 4;
        const R = data[offset + 0];
        const G = data[offset + 1];
        const B = data[offset + 2];

        const c1 = R % 64;
        const c2 = G % 64;
        const c3 = B % 64;

        const rL = Math.floor(R / 64);
        const gL = Math.floor(G / 64);
        const bL = Math.floor(B / 64);
        const c4 = rL * 16 + gL * 4 + bL;

        charIndices.push(c1, c2, c3, c4);
      }

      // å¿…è¦ãªé•·ã•åˆ†ã ã‘ Base64 æ–‡å­—åˆ—ã‚’çµ„ã¿ç«‹ã¦ã‚‹
      if (charIndices.length < len) {
        throw new Error("ç”»åƒã®ãƒ”ã‚¯ã‚»ãƒ«æ•°ãŒä¸è¶³ã—ã¦ãŠã‚Šã€Base64é•·ã¨çŸ›ç›¾ã—ã¦ã„ã¾ã™ã€‚");
      }

      let b64 = "";
      for (let i = 0; i < len; i++) {
        const idx = charIndices[i];
        if (idx < 0 || idx >= 64) {
          throw new Error("Base64ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç¯„å›²å¤–ã§ã™ã€‚");
        }
        b64 += B64_CHARS[idx];
      }

      // '=' ã‚’å¾©å…ƒ
      b64 += "=".repeat(paddingCount);

      setStatus("ZIPãƒã‚¤ãƒˆåˆ—ã«å¾©å…ƒä¸­â€¦");
      const zipBytes = base64ToBytes(b64);

      // ZIP Blob ã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const zipBlob = new Blob([zipBytes], { type: "application/zip" });
      const zipURL = URL.createObjectURL(zipBlob);
      const link = document.createElement("a");
      const baseName = selectedImgFile.name.replace(/\.(png|jpg|jpeg|webp|bmp)$/i, "");
      link.href = zipURL;
      link.download = baseName + "_decoded.zip";
      link.textContent = "å¾©å…ƒã•ã‚ŒãŸZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";

      zipDownloadArea.innerHTML = "";
      zipDownloadArea.appendChild(link);
      previewZipLabel.textContent = "ZIPã®å¾©å…ƒã«æˆåŠŸã—ã¾ã—ãŸï¼";

      decoderMetaRow.style.display = "flex";
      metaZipSize.textContent = "ZIPã‚µã‚¤ã‚º: " + formatBytes(zipBytes.length);
      metaB64LenDec.textContent = "Base64é•·: " + len + "æ–‡å­—";
      metaPadding.textContent = "padding '=' ã®æ•°: " + paddingCount;

      setStatus("ZIPã®å¾©å…ƒã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚", "ok");
    } catch (err) {
      console.error(err);
      alert("ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
      setStatus("ã‚¨ãƒ©ãƒ¼: " + err.message, "error");
    } finally {
      actionButton.disabled = false;
    }
  }

  // ===== ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ =====
  actionButton.addEventListener("click", () => {
    if (currentMode === "zip-to-img") {
      encodeZipToImage();
    } else {
      decodeImageToZip();
    }
  });

  // ===== ä»•æ§˜ãƒ¡ãƒ¢ã®é–‹é–‰ =====
  let infoOpen = true;
  toggleInfo.addEventListener("click", () => {
    infoOpen = !infoOpen;
    infoBlock.style.display = infoOpen ? "block" : "none";
    toggleInfo.innerHTML = infoOpen ? `<span>ä»•æ§˜ãƒ¡ãƒ¢</span> <span>ğŸ“˜</span>` : `<span>ä»•æ§˜ãƒ¡ãƒ¢</span> <span>ğŸ“—</span>`;
  });
</script>
</body>
</html>
