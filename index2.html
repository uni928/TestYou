<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>文字スワップ（圧縮+Base64 対応版）</title>
  <meta name="description" content="スマホ間でテキストをやり取り。送信時にDeflate圧縮→Base64URL化してリンク/QRで共有。受信時に自動復元。" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QR生成 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- QR読み取り -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <!-- 圧縮ライブラリ（pako） -->
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif; }
    .bg-animated { background: radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,.35), transparent 60%), radial-gradient(800px 500px at 90% 20%, rgba(16,185,129,.3), transparent 60%), radial-gradient(900px 600px at 40% 90%, rgba(236,72,153,.25), transparent 60%), linear-gradient(120deg, #0f172a, #111827 35%, #0b1220); background-size: 300% 300%; animation: gradientShift 18s ease infinite; }
    @keyframes gradientShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .glass { backdrop-filter: blur(16px) saturate(120%); background-color: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); }
    #videoPreview { border-radius: 1rem; border: 1px dashed rgba(255,255,255,.25); }
  </style>
</head>
<body class="bg-animated text-white min-h-screen">
  <header class="px-4 pt-8 pb-2 md:px-8">
    <h1 class="text-3xl md:text-4xl font-bold tracking-tight">文字スワップ <span class="text-sm opacity-75 align-middle">— 圧縮+Base64URL 共有</span></h1>
  </header>

  <main class="px-4 md:px-8 pb-10">
    <section class="glass rounded-3xl p-5 md:p-8 shadow-xl">
      <div class="flex flex-wrap gap-2 mb-5">
        <button id="tabSend" class="bg-white/15 hover:bg-white/25 rounded-2xl px-4 py-2 text-sm" aria-selected="true">送る（圧縮→Base64→QR/リンク）</button>
        <button id="tabScan" class="bg-white/10 hover:bg-white/20 rounded-2xl px-4 py-2 text-sm">受け取る（QR読取）</button>
        <button id="tabHelp" class="bg-white/10 hover:bg-white/20 rounded-2xl px-4 py-2 text-sm">使い方</button>
      </div>

      <!-- 送信タブ -->
      <div id="panelSend" class="grid gap-5 md:grid-cols-2">
        <div class="space-y-4">
          <label class="block text-sm opacity-90">送りたいテキスト</label>
          <textarea id="inputText" class="w-full rounded-2xl bg-white/5 border border-white/10 p-4 min-h-[10rem] focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="ここにテキストを入力"></textarea>
          <div class="flex items-center justify-between text-xs opacity-80">
            <span id="charCount">0 文字</span>
            <span>送信データは Deflate 圧縮後、Base64URL でリンク化します</span>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-2">
            <button class="w-full bg-indigo-500 hover:bg-indigo-400 text-white rounded-2xl px-4 py-3 text-sm font-semibold" id="btnMakeQR">QRを作る</button>
            <button class="w-full bg-white/15 hover:bg-white/25 rounded-2xl px-4 py-3 text-sm" id="btnFullQR">フルスクリーンQR</button>
          </div>

          <div class="grid grid-cols-3 gap-3 mt-2">
            <button class="bg-white/15 hover:bg-white/25 rounded-2xl px-4 py-3 text-sm" id="btnCopyLink">リンクをコピー</button>
            <button class="bg-white/15 hover:bg-white/25 rounded-2xl px-4 py-3 text-sm" id="btnShare">リンクを共有</button>
            <button class="bg-white/15 hover:bg-white/25 rounded-2xl px-4 py-3 text-sm" id="btnCopyB64">Base64をコピー</button>
          </div>
        </div>

        <div class="space-y-3">
          <div id="qrContainer" class="w-full aspect-square bg-white rounded-2xl grid place-items-center overflow-hidden">
            <div class="text-center text-slate-700">
              <p class="font-semibold">ここにQRコードが表示されます</p>
              <p class="text-xs opacity-70 mt-1">テキストを入力して「QRを作る」を押してください</p>
            </div>
          </div>
          <div class="text-xs opacity-90 space-y-1">
            <p>リンク：<span id="linkPreview" class="break-all"></span></p>
            <p>Base64URL：<span id="b64Preview" class="break-all"></span></p>
          </div>
        </div>
      </div>

      <!-- 受信タブ（QRスキャン） -->
      <div id="panelScan" class="hidden grid gap-5 md:grid-cols-2">
        <div class="space-y-4 order-2 md:order-1">
          <label class="block text-sm opacity-90">復元したテキスト</label>
          <textarea id="scanResult" class="w-full rounded-2xl bg-white/5 border border-white/10 p-4 min-h-[10rem] focus:outline-none" placeholder="ここに読み取った文字が表示されます" readonly></textarea>
          <div class="grid grid-cols-2 gap-3">
            <button class="bg-indigo-500 hover:bg-indigo-400 text-white rounded-2xl px-4 py-3 text-sm" id="btnCopyScanned">コピー</button>
            <button class="bg-white/15 hover:bg-white/25 rounded-2xl px-4 py-3 text-sm" id="btnStop">カメラを停止</button>
          </div>
          <p class="text-xs opacity-80">※ 読み取りに成功すると自動で停止します。</p>
        </div>
        <div class="space-y-3 order-1 md:order-2">
          <div class="relative">
            <video id="videoPreview" class="w-full aspect-square object-cover"></video>
            <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
              <div class="w-2/3 h-2/3 rounded-2xl border-2 border-white/70"></div>
            </div>
            <button id="btnStart" class="absolute bottom-3 left-3 bg-white/15 hover:bg-white/25 rounded-xl px-4 py-2 text-sm">カメラ開始</button>
            <button id="btnTorch" class="absolute bottom-3 right-3 bg-white/15 hover:bg-white/25 rounded-xl px-4 py-2 text-sm hidden">ライト</button>
          </div>
        </div>
      </div>

      <!-- 使い方タブ -->
      <div id="panelHelp" class="hidden text-sm leading-7 opacity-95">
        <p>このページは <strong>Deflate圧縮 → Base64URL</strong> でテキストをエンコードし、<code>#c=...</code> の形式でURLハッシュに載せます。受信側で自動復元します。</p>
        <ul class="list-disc list-inside mt-2 space-y-1">
          <li>日本語などユニコード文字も安全に扱えます。</li>
          <li>長文はQRが細かくなるため、リンク共有の利用を推奨します。</li>
          <li>端末保存（localStorage / IndexedDB）は使用しません。</li>
        </ul>
      </div>
    </section>

    <footer class="text-xs opacity-70 mt-6 text-center">© 2025 文字スワップ — Deflate+Base64URL</footer>
  </main>

  <!-- フルスクリーンQR用モーダル -->
  <dialog id="qrDialog" class="backdrop:bg-black/60 rounded-3xl p-0 w-[92vw] max-w-[520px]">
    <div class="bg-white text-slate-800 rounded-3xl overflow-hidden">
      <div class="p-4 flex items-center justify-between border-b">
        <h2 class="font-semibold">QRを表示</h2>
        <button id="btnCloseDialog" class="text-slate-500 hover:text-slate-800 p-2" aria-label="閉じる">✕</button>
      </div>
      <div class="p-4">
        <div id="qrBig" class="w-full aspect-square"></div>
        <p class="text-xs mt-3 break-all">リンク：<span id="linkInDialog"></span></p>
      </div>
    </div>
  </dialog>

  <script>
    // --- DOM 参照
    const inputText = document.getElementById('inputText');
    const charCount = document.getElementById('charCount');
    const linkPreview = document.getElementById('linkPreview');
    const b64Preview = document.getElementById('b64Preview');
    const btnMakeQR = document.getElementById('btnMakeQR');
    const btnFullQR = document.getElementById('btnFullQR');
    const btnCopyLink = document.getElementById('btnCopyLink');
    const btnCopyB64 = document.getElementById('btnCopyB64');
    const btnShare = document.getElementById('btnShare');
    const qrContainer = document.getElementById('qrContainer');

    const panelSend = document.getElementById('panelSend');
    const panelScan = document.getElementById('panelScan');
    const panelHelp = document.getElementById('panelHelp');
    const tabSend = document.getElementById('tabSend');
    const tabScan = document.getElementById('tabScan');
    const tabHelp = document.getElementById('tabHelp');

    const qrDialog = document.getElementById('qrDialog');
    const qrBig = document.getElementById('qrBig');
    const linkInDialog = document.getElementById('linkInDialog');
    const btnCloseDialog = document.getElementById('btnCloseDialog');

    const scanResult = document.getElementById('scanResult');
    const videoPreview = document.getElementById('videoPreview');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnTorch = document.getElementById('btnTorch');
    const btnCopyScanned = document.getElementById('btnCopyScanned');

    let qr, qrLarge, stream, rafId, torchOn = false, track;

    // --- タブ切替
    function showPanel(which){
      for (const [tab, panel] of [[tabSend,panelSend],[tabScan,panelScan],[tabHelp,panelHelp]]){
        const active = (panel === which);
        panel.classList.toggle('hidden', !active);
        tab.setAttribute('aria-selected', active);
        tab.classList.toggle('bg-white/20', active);
      }
    }
    tabSend.addEventListener('click', ()=> showPanel(panelSend));
    tabScan.addEventListener('click', ()=> showPanel(panelScan));
    tabHelp.addEventListener('click', ()=> showPanel(panelHelp));

    // --- 文字数
    function updateCount(){ charCount.textContent = `${inputText.value.length} 文字`; updatePreviews(); }
    inputText.addEventListener('input', updateCount);

    // === 圧縮・Base64URL ===
    function textToUint8(text){ return new TextEncoder().encode(text); }
    function uint8ToText(u8){ return new TextDecoder().decode(u8); }

    function toBase64(u8){ // Uint8Array -> Base64
      let bin = '';
      const chunk = 0x8000;
      for (let i=0; i<u8.length; i+=chunk){ bin += String.fromCharCode.apply(null, u8.subarray(i, i+chunk)); }
      return btoa(bin);
    }
    function fromBase64(b64){ // Base64 -> Uint8Array
      const bin = atob(b64);
      const u8 = new Uint8Array(bin.length);
      for (let i=0; i<bin.length; i++){ u8[i] = bin.charCodeAt(i); }
      return u8;
    }
    function toBase64URL(b64){ return b64.replaceAll('+','-').replaceAll('/','_').replace(/=+$/,''); }
    function fromBase64URL(s){ const pad = s.length % 4 === 2 ? '==' : s.length % 4 === 3 ? '=' : ''; return s.replaceAll('-','+').replaceAll('_','/') + pad; }

    function encodeCompressed(text){
      const def = pako.deflate(textToUint8(text), { level: 9 });
      const b64 = toBase64(def);
      return toBase64URL(b64);
    }
    function decodeCompressed(b64url){
      const b64 = fromBase64URL(b64url);
      const u8 = fromBase64(b64);
      const infl = pako.inflate(u8);
      return uint8ToText(infl);
    }

    // --- リンク生成（#c= Base64URL）
    function buildLink(){
      const base = location.href.split('#')[0];
      const b64url = encodeCompressed(inputText.value);
      return `${base}#c=${b64url}`;
    }

    function updatePreviews(){
      const b64url = encodeCompressed(inputText.value || '');
      const link = location.href.split('#')[0] + `#c=${b64url}`;
      linkPreview.textContent = link;
      b64Preview.textContent = b64url;
    }

    // --- QR生成（白余白付き）
    function clearQR(target){ target.innerHTML = ''; }
 function makeQR(target, text){
   clearQR(target);
   const size = target.clientWidth || 300;
   return new QRCode(target, { text, width: size, height: size, correctLevel: QRCode.CorrectLevel.M });
 }

    btnMakeQR.addEventListener('click', ()=>{ const link = buildLink(); makeQR(qrContainer, link); });
    btnFullQR.addEventListener('click', ()=>{ const link = buildLink(); makeQR(qrBig, link); linkInDialog.textContent = link; if (qrDialog.showModal) qrDialog.showModal(); });
    btnCloseDialog.addEventListener('click', ()=>{ qrDialog.close(); qrBig.innerHTML=''; });

    // --- 共有／コピー
    btnCopyLink.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(buildLink()); toast('リンクをコピーしました'); }catch{ toast('コピーに失敗'); } });
    btnCopyB64.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(b64Preview.textContent); toast('Base64URLをコピーしました'); }catch{ toast('コピーに失敗'); } });
    btnShare.addEventListener('click', async()=>{
      const url = buildLink();
      if (navigator.share){ try{ await navigator.share({ title: '文字スワップ', text: '圧縮+Base64URLで共有', url }); }catch{} }
      else { try{ await navigator.clipboard.writeText(url); toast('共有非対応のためリンクをコピーしました'); }catch{} }
    });

    // --- 起動時：#c= の自動復元
    function readFromHash(){
      const h = new URL(location.href).hash;
      if (h.startsWith('#c=')){
        const c = h.slice(3);
        try { const text = decodeCompressed(c); inputText.value = text; scanResult.value = text; toast('リンクから復元しました'); }
        catch(e){ console.warn(e); toast('復元に失敗しました'); }
      }
      updateCount();
    }

    // --- トースト
    let toastTimer; function toast(msg){ let el = document.getElementById('toast'); if (!el){ el = document.createElement('div'); el.id='toast'; el.className='fixed left-1/2 -translate-x-1/2 bottom-6 bg-white/90 text-slate-900 rounded-full px-4 py-2 text-sm shadow-lg'; document.body.appendChild(el);} el.textContent = msg; el.style.opacity='1'; clearTimeout(toastTimer); toastTimer=setTimeout(()=> el.style.opacity='0', 1600); }

    // --- カメラ＆QR読み取り
    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
    async function startCamera(){
      try { const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); stream = s; videoPreview.srcObject = s; await videoPreview.play(); track = s.getVideoTracks()[0]; const caps = track.getCapabilities?.()||{}; if (caps.torch) btnTorch.classList.remove('hidden'); scanLoop(); }
      catch(e){ toast('カメラ開始に失敗'); }
    }
    function stopCamera(){ if (rafId) cancelAnimationFrame(rafId); if (videoPreview.srcObject){ videoPreview.pause(); videoPreview.srcObject.getTracks().forEach(t=>t.stop()); videoPreview.srcObject=null; } btnTorch.classList.add('hidden'); track=null; }
    function scanLoop(){ const vw=videoPreview.videoWidth, vh=videoPreview.videoHeight; if(!vw||!vh){ rafId=requestAnimationFrame(scanLoop); return; } const size=Math.min(vw,vh); const sx=(vw-size)/2, sy=(vh-size)/2; canvas.width=size; canvas.height=size; ctx.drawImage(videoPreview,sx,sy,size,size,0,0,size,size); const img=ctx.getImageData(0,0,size,size); const code=jsQR(img.data,size,size,{inversionAttempts:'dontInvert'}); if(code&&code.data){ stopCamera(); handleScanned(code.data); return;} rafId=requestAnimationFrame(scanLoop); }

    function handleScanned(data){
      try {
        const url = new URL(data);
        if (url.hash.startsWith('#c=')){
          const text = decodeCompressed(url.hash.slice(3));
          scanResult.value = text; inputText.value = text; updateCount(); toast('読み取り→復元しました'); return; }
      } catch(_){ /* URLでない場合もある */ }
      // 直接Base64URL文字列を読ませた場合にも対応
      if (data.startsWith('c=')){
        try{ const text = decodeCompressed(data.slice(2)); scanResult.value=text; inputText.value=text; updateCount(); toast('復元しました'); return; }catch{}
      }
      // それ以外は生テキスト扱い
      scanResult.value = data; inputText.value = data; updateCount(); toast('テキストを取得しました');
    }

    btnStart.addEventListener('click', startCamera);
    btnStop && btnStop.addEventListener('click', stopCamera);
    btnTorch.addEventListener('click', async()=>{ if (!track) return; try { const caps = track.getCapabilities?.(); if (caps && caps.torch){ const current = track.getSettings?.(); const next = !(current && current.torch); await track.applyConstraints({ advanced: [{ torch: next }] }); } } catch{} });
    btnCopyScanned.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(scanResult.value); toast('コピーしました'); }catch{ toast('コピー失敗'); } });

    // 初期化
    readFromHash();
    showPanel(panelSend);

    // 画面サイズ変更時にQRを作り直す（サイズ合わせ）
    window.addEventListener('resize', ()=>{ if (inputText.value){ qrContainer.innerHTML=''; } });
  </script>
</body>
</html>
