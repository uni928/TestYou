<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ–‡ç«  â‡„ ç”»åƒ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #1f2933, #111827);
      --card-bg: rgba(17, 24, 39, 0.9);
      --accent: #60a5fa;
      --accent-soft: rgba(96, 165, 250, 0.15);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f87171;
      --radius-lg: 18px;
      --radius-xl: 24px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.75);
      --shadow-sm: 0 6px 18px rgba(15, 23, 42, 0.6);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .wrapper {
      width: 100%;
      max-width: 1200px;
    }

    .header {
      text-align: center;
      margin-bottom: 18px;
    }

    .title {
      font-size: clamp(1.6rem, 2.4vw, 2rem);
      font-weight: 700;
      letter-spacing: 0.04em;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .title-pill {
      font-size: 0.7rem;
      text-transform: uppercase;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: rgba(15, 23, 42, 0.8);
      color: var(--accent);
    }

    .subtitle {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .card {
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.18), transparent 55%) no-repeat,
                  radial-gradient(circle at bottom right, rgba(244, 114, 182, 0.18), transparent 55%) no-repeat,
                  var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(75, 85, 99, 0.6);
      padding: 18px 18px 20px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.07), transparent 50%);
      opacity: 0.6;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap: 18px;
    }

    @media (max-width: 860px) {
      .card-inner {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.75);
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 10px;
      backdrop-filter: blur(12px);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .panel-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.65rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
    }

    .pill-primary {
      border-color: rgba(96, 165, 250, 0.7);
      background: var(--accent-soft);
      color: #bfdbfe;
    }

    .panel-description {
      font-size: 0.78rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    textarea {
      width: 100%;
      resize: vertical;
      min-height: 150px;
      max-height: 280px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(51, 65, 85, 0.8);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-main);
      font-size: 0.9rem;
      line-height: 1.5;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.35);
      background: rgba(15, 23, 42, 0.95);
    }

    textarea::placeholder {
      color: #6b7280;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 2px;
      align-items: center;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: radial-gradient(circle at top left, rgba(96, 165, 250, 0.7), rgba(56, 189, 248, 0.8));
      color: #0b1120;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      white-space: nowrap;
    }

    button.small {
      padding: 5px 12px;
      font-size: 0.72rem;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.7);
      background: rgba(31, 41, 55, 0.95);
      color: #e5e7eb;
    }

    button.outline {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: none;
      color: var(--text-muted);
    }

    button.secondary {
      background: radial-gradient(circle at top left, rgba(251, 191, 36, 0.85), rgba(249, 115, 22, 0.85));
      box-shadow: 0 10px 22px rgba(245, 158, 11, 0.55);
      color: #111827;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(37, 99, 235, 0.5);
      filter: brightness(1.03);
    }

    button.small:hover {
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.9);
    }

    button.secondary:hover {
      box-shadow: 0 14px 26px rgba(245, 158, 11, 0.7);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.9);
      filter: brightness(0.97);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
      filter: none;
    }

    .icon {
      font-size: 0.9em;
    }

    .preview-card {
      border-radius: 12px;
      border: 1px dashed rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.8);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .preview-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .preview-label-row span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .preview-frame {
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at 20% 0, rgba(55, 65, 81, 0.7), rgba(15, 23, 42, 1));
      min-height: 140px;
      max-height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .preview-frame img {
      width: 100%;
      height: auto;
      max-height: 260px;
      object-fit: contain;
      display: block;
    }

    .preview-placeholder {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
      padding: 18px 18px;
    }

    .preview-tag {
      position: absolute;
      left: 10px;
      bottom: 10px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 0.7rem;
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .info-list {
      margin: 3px 0 0;
      padding-left: 16px;
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .info-list li + li {
      margin-top: 2px;
    }

    .field-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 2px;
    }

    .field-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .field-label span:last-child {
      opacity: 0.7;
    }

    .input-line {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .input-text {
      flex: 1 1 auto;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      padding: 6px 11px;
      font-size: 0.78rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .input-text::placeholder {
      color: #6b7280;
    }

    .input-text:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.45);
      background: rgba(15, 23, 42, 0.98);
    }

    .helper {
      font-size: 0.73rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 2px;
    }

    .helper strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    .badge-auto {
      border-radius: 999px;
      border: 1px solid rgba(52, 211, 153, 0.55);
      color: #6ee7b7;
      font-size: 0.65rem;
      padding: 2px 7px;
      background: rgba(6, 95, 70, 0.35);
    }

    .status {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 2px;
      min-height: 1em;
    }

    .status.error {
      color: var(--danger);
    }

    .status.success {
      color: #6ee7b7;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 0.7rem;
      color: #6b7280;
      text-align: center;
    }

    .footer-note code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.72rem;
      background: rgba(15, 23, 42, 0.95);
      padding: 1px 5px;
      border-radius: 4px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }
  </style>
</head>
<body>
<div class="wrapper">
  <header class="header">
    <div class="title">
      <span>æ–‡ç«  â‡„ ç”»åƒ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€</span>
      <span class="title-pill">Base64 Ã— Canvas</span>
    </div>
    <p class="subtitle">
      æ–‡ç« ã‚’Base64ã§ç¬¦å·åŒ–ã—ã€RGBãƒ”ã‚¯ã‚»ãƒ«ã«åŸ‹ã‚è¾¼ã‚“ã PNGç”»åƒã¨ã—ã¦ä¿å­˜ï¼å…±æœ‰ã§ãã¾ã™ã€‚<br>
      ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ <code>?img=ç”»åƒURL</code> ãŒã‚ã‚‹å ´åˆã¯ã€ãã®ç”»åƒã‹ã‚‰æ–‡ç« ã‚’è‡ªå‹•å¾©å…ƒã—ã¾ã™ã€‚
    </p>
  </header>

  <main class="card">
    <div class="card-inner">
      <!-- Text â†’ Image -->
      <section class="panel" aria-label="æ–‡ç« ã‹ã‚‰ç”»åƒã‚’ç”Ÿæˆ">
        <div class="panel-header">
          <div class="panel-title">
            <span class="pill pill-primary">Text â†’ Image</span>
            <span>æ–‡ç« ã‚’ç”»åƒã«åŸ‹ã‚è¾¼ã‚€</span>
          </div>
        </div>
        <p class="panel-description">
          å…¥åŠ›ã—ãŸæ–‡ç« ã‚’UTF-8 â†’ Base64ã«å¤‰æ›ã—ã€Base64æ–‡å­—åˆ—ã‚’RGBãƒ”ã‚¯ã‚»ãƒ«ã«å‰²ã‚Šå½“ã¦ã¦PNGç”»åƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚
          1ãƒ”ã‚¯ã‚»ãƒ«ã«æœ€å¤§3æ–‡å­—åˆ†ã®æƒ…å ±ãŒå…¥ã‚Šã¾ã™ã€‚
        </p>

        <label class="field-row">
          <div class="field-label">
            <span>ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹æ–‡ç« </span>
            <span>æ—¥æœ¬èªãƒ»çµµæ–‡å­—ã‚‚OK</span>
          </div>
          <textarea id="textInput"
                    placeholder="ä¾‹ï¼šã“ã®æ–‡ç« ã‚’ç”»åƒã«å¤‰æ›ã—ã€ç”»åƒã‹ã‚‰ã¾ãŸæ–‡ç« ã«æˆ»ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚"></textarea>
        </label>

        <div class="button-row">
          <button id="encodeBtn" type="button">
            <span class="icon">ğŸ¨</span>
            <span>ç”»åƒã‚’ç”Ÿæˆ</span>
          </button>
          <button id="clearTextBtn" type="button" class="small outline">
            æ–‡ç« ã‚’ã‚¯ãƒªã‚¢
          </button>
        </div>

        <div class="preview-card">
          <div class="preview-label-row">
            <span><span class="icon">ğŸ–¼ï¸</span>ç”Ÿæˆã•ã‚ŒãŸç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
            <span style="display:flex; gap:6px; align-items:center;">
              <button id="downloadBtn" type="button" class="small secondary" disabled>PNGã‚’ä¿å­˜</button>
              <span style="font-size:0.7rem; color:#6b7280;">å³ã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜ã‚‚OK</span>
            </span>
          </div>
          <div class="preview-frame" id="encodePreview">
            <div class="preview-placeholder">
              ã“ã“ã«ç”Ÿæˆã—ãŸç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
              ç”»åƒã«ã¯ã€Base64ã«å¤‰æ›ã•ã‚ŒãŸæ–‡ç« ãŒãƒ”ã‚¯ã‚»ãƒ«ã¨ã—ã¦åŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚
            </div>
          </div>
          <div class="field-row">
            <div class="field-label">
              <span>ã“ã®ç”»åƒã‚’å¾©å·ç”¨URLã¨ã—ã¦å…±æœ‰</span>
            </div>
            <div class="input-line">
              <input id="shareUrl" class="input-text" type="text" readonly
                     placeholder="ç”»åƒç”Ÿæˆå¾Œã«ã€ã“ã“ã« ?img= ä»˜ãã®URLã‚’è¡¨ç¤ºã—ã¾ã™">
              <button id="copyShareUrlBtn" type="button" class="small outline" disabled>URLã‚³ãƒ”ãƒ¼</button>
            </div>
            <div class="helper">
              <span>ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç„¡ã—ã‚¢ã‚¯ã‚»ã‚¹ â†’ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</span><br>
              <span>ãƒ»<strong>?img=</strong>ä»˜ãURLã§ã‚¢ã‚¯ã‚»ã‚¹ â†’ ç”»åƒã‹ã‚‰è‡ªå‹•å¾©å·</span>
            </div>
          </div>
        </div>
        <ul class="info-list">
          <li>ç”»åƒã¯PNGå½¢å¼ã§ç”Ÿæˆã•ã‚Œã¾ã™ã€‚</li>
          <li>1ãƒ”ã‚¯ã‚»ãƒ«ç›®ã®RGBã«ã¯ã€ŒBase64æ–‡å­—åˆ—ã®é•·ã•ã€ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã€æ®‹ã‚Šã®ãƒ”ã‚¯ã‚»ãƒ«ã§æœ¬æ–‡ã‚’è¡¨ç¾ã—ã¾ã™ã€‚</li>
          <li>Base64ã®æ–‡å­—ï¼ˆAã€œZ, aã€œz, 0ã€œ9, +, /ï¼‰ã‚’ãã®ã¾ã¾RGBã®å€¤ã¨ã—ã¦å‰²ã‚Šå½“ã¦ã¦ã„ãã¾ã™ã€‚</li>
        </ul>
        <canvas id="encodeCanvas" style="display:none;"></canvas>
      </section>

      <!-- Image â†’ Text -->
      <section class="panel" aria-label="ç”»åƒã‹ã‚‰æ–‡ç« ã‚’å¾©å·">
        <div class="panel-header">
          <div class="panel-title">
            <span class="pill">Image â†’ Text</span>
            <span>ç”»åƒã‹ã‚‰æ–‡ç« ã«æˆ»ã™</span>
          </div>
          <span id="autoBadge" class="badge-auto" style="display:none;">URLã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿ä¸­</span>
        </div>
        <p class="panel-description">
          ã“ã®ãƒ„ãƒ¼ãƒ«ã§ç”Ÿæˆã—ãŸç”»åƒã‚’èª­ã¿è¾¼ã‚€ã¨ã€Base64 â†’ UTF-8ã®é€†å¤‰æ›ã‚’è¡Œã„ã€æ–‡ç« ã‚’å¾©å…ƒã—ã¾ã™ã€‚
          ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ <code>?img=...</code> çµŒç”±ã®ç”»åƒURLãŒã‚ã‚‹å ´åˆã¯ã€è‡ªå‹•ã§èª­ã¿è¾¼ã¿ï¼†å¾©å·ã‚’è¡Œã„ã¾ã™ã€‚
        </p>

        <div class="field-row">
          <div class="field-label">
            <span>ç”»åƒURLã‚’æŒ‡å®š</span>
            <span>data URL / åŒä¸€ã‚ªãƒªã‚¸ãƒ³æ¨å¥¨</span>
          </div>
          <div class="input-line">
            <input id="imageUrlInput" class="input-text"
                   placeholder="ä¾‹ï¼šhttps://example.com/encoded-text.png ã¾ãŸã¯ data:image/png;base64,...">
            <button id="loadUrlBtn" type="button" class="small">URLã‹ã‚‰èª­ã¿è¾¼ã¿</button>
          </div>
          <div class="helper">
            <span class="icon">â„¹ï¸</span>
            <span>å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç”»åƒã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆCORSï¼‰ã«ã‚ˆã‚Šèª­ã¿è¾¼ã‚ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</span>
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">
            <span>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</span>
            <span>PNGãƒ•ã‚¡ã‚¤ãƒ«</span>
          </div>
          <div class="input-line">
            <input id="fileInput" type="file" accept="image/png"
                   style="font-size:0.75rem; color:#9ca3af;">
            <button id="decodeBtn" type="button" class="small secondary" disabled>
              <span class="icon">ğŸ”</span>ç”»åƒã‹ã‚‰æ–‡ç« ã«å¤‰æ›
            </button>
          </div>
        </div>

        <div class="preview-card">
          <div class="preview-label-row">
            <span><span class="icon">ğŸ‘ï¸</span>è§£æå¯¾è±¡ç”»åƒ</span>
          </div>
          <div class="preview-frame">
            <img id="loadedImage" alt="è§£æå¯¾è±¡ç”»åƒ" style="display:none;">
            <div id="loadedPlaceholder" class="preview-placeholder">
              URLã‚‚ã—ãã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ã“ã“ã«ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
              ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ <code>?img=...</code> ã‚’ä»˜ã‘ã¦ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸå ´åˆã¯ã€è‡ªå‹•çš„ã«ã“ã“ã«ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚
            </div>
            <div class="preview-tag">
              <span class="icon">ğŸ¯</span>
              <span>ã“ã®ç”»åƒã®RGBå€¤ã‹ã‚‰æ–‡ç« ã‚’å¾©å·</span>
            </div>
          </div>
        </div>

        <label class="field-row">
          <div class="field-label">
            <span>å¾©å·ã•ã‚ŒãŸæ–‡ç« </span>
            <span>èª­ã¿å–ã‚Šå°‚ç”¨</span>
          </div>
          <textarea id="decodedText" readonly
                    placeholder="ã“ã“ã«å¾©å…ƒã•ã‚ŒãŸæ–‡ç« ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"></textarea>
        </label>

        <div class="button-row">
          <button id="copyDecodedBtn" type="button" class="small outline" disabled>
            æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼
          </button>
          <span id="decodeStatus" class="status"></span>
        </div>

        <canvas id="decodeCanvas" style="display:none;"></canvas>
      </section>
    </div>

    <p class="footer-note">
      â€» ç”»åƒã‹ã‚‰ã®å¾©å·ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã§ç”Ÿæˆã•ã‚ŒãŸç”»åƒï¼ˆåŒã˜ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹å¼ï¼‰ã«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚<br>
      â€» ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã«ã‚ˆã‚Šã€ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ç”»åƒï¼ˆåˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ã¯è§£æã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
    </p>
  </main>
</div>

<script>
  // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: Base64ã¨ã®ç›¸äº’å¤‰æ›ï¼ˆUTF-8å¯¾å¿œï¼‰ ---
  function textToBase64Utf8(text) {
    const encoder = new TextEncoder();
    const bytes = encoder.encode(text);
    let binary = "";
    for (let i = 0; i < bytes.length; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary); // Base64æ–‡å­—åˆ—
  }

  function base64Utf8ToText(b64) {
    const binary = atob(b64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    const decoder = new TextDecoder();
    return decoder.decode(bytes);
  }

  // --- æ–‡ç«  â†’ ç”»åƒ ---
  function encodeTextToImage() {
    const textArea = document.getElementById('textInput');
    const text = textArea.value;
    const statusEl = document.getElementById('decodeStatus'); // å†åˆ©ç”¨ã—ãªã„ãŒå¿µã®ãŸã‚
    if (!text) {
      alert('ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    let b64;
    try {
      b64 = textToBase64Utf8(text);
    } catch (e) {
      alert('æ–‡ç« ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      return;
    }

    const length = b64.length;
    // 1ãƒ”ã‚¯ã‚»ãƒ«ç›®ã¯é•·ã•æƒ…å ±ç”¨ã€‚æ®‹ã‚Šã®ãƒ”ã‚¯ã‚»ãƒ«ã§ Base64æ–‡å­—åˆ—ã‚’3æ–‡å­—ãšã¤æ ¼ç´ã€‚
    const pixelsNeeded = Math.ceil(length / 3) + 1;
    const width = 64;
    const height = Math.ceil(pixelsNeeded / width);

    const canvas = document.getElementById('encodeCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = width;
    canvas.height = height;

    const imageData = ctx.createImageData(width, height);
    const data = imageData.data;

    // 1ãƒ”ã‚¯ã‚»ãƒ«ç›®ã«é•·ã•æƒ…å ±ã‚’åŸ‹ã‚è¾¼ã‚€ï¼ˆR=ä¸Šä½8bit, G=ä¸­ä½8bit, B=ä¸‹ä½8bitï¼‰
    data[0] = (length >> 16) & 255;
    data[1] = (length >> 8) & 255;
    data[2] = length & 255;
    data[3] = 255;

    let charIndex = 0;
    // æ®‹ã‚Šã®ãƒ”ã‚¯ã‚»ãƒ«ã« Base64 æ–‡å­—ã‚’ 3 æ–‡å­—ãšã¤æ ¼ç´
    for (let p = 1; p < pixelsNeeded; p++) {
      const offset = p * 4;
      const c1 = charIndex < length ? b64.charCodeAt(charIndex++) : 0;
      const c2 = charIndex < length ? b64.charCodeAt(charIndex++) : 0;
      const c3 = charIndex < length ? b64.charCodeAt(charIndex++) : 0;

      data[offset]     = c1;
      data[offset + 1] = c2;
      data[offset + 2] = c3;
      data[offset + 3] = 255;
    }

    // ä½™ã£ãŸãƒ”ã‚¯ã‚»ãƒ«ã‚‚ã‚¢ãƒ«ãƒ•ã‚¡ã ã‘255ã«ã—ã¦ãŠã
    const totalPixels = width * height;
    for (let p = pixelsNeeded; p < totalPixels; p++) {
      const offset = p * 4;
      data[offset]     = 0;
      data[offset + 1] = 0;
      data[offset + 2] = 0;
      data[offset + 3] = 255;
    }

    ctx.putImageData(imageData, 0, 0);

    const dataUrl = canvas.toDataURL('image/png');

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åæ˜ 
    const previewContainer = document.getElementById('encodePreview');
    previewContainer.innerHTML = '';
    const img = document.createElement('img');
    img.src = dataUrl;
    img.alt = 'æ–‡ç« ã‚’åŸ‹ã‚è¾¼ã‚“ã ç”»åƒ';
    previewContainer.appendChild(img);

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.disabled = false;
    downloadBtn.onclick = function () {
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = 'encoded-text.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    // ?img=ç”¨URLã‚’ç”Ÿæˆ
    const shareInput = document.getElementById('shareUrl');
    const copyBtn = document.getElementById('copyShareUrlBtn');
    try {
      const basePath = (window.location.origin && window.location.origin !== 'null')
        ? window.location.origin + window.location.pathname
        : window.location.pathname;

      const url = basePath + '?
