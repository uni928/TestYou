<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¢ãƒ«ãƒ•ã‚¡ãƒãƒ£ãƒ³ãƒãƒ«ZIPåŸ‹ã‚è¾¼ã¿ãƒ„ãƒ¼ãƒ«</title>
<style>
    :root {
        color-scheme: dark light;
        --bg: #0f172a;
        --bg-soft: #111827;
        --card: #111827;
        --accent: #38bdf8;
        --accent-soft: rgba(56,189,248,0.1);
        --border: rgba(148,163,184,0.5);
        --text-main: #e5e7eb;
        --text-sub: #9ca3af;
        --danger: #f97373;
    }
    * { box-sizing: border-box; }
    body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top left, #1e293b, #020617 60%);
        color: var(--text-main);
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: 24px;
    }
    .app {
        max-width: 1200px;
        width: 100%;
        background: radial-gradient(circle at top right, rgba(56,189,248,0.1), rgba(15,23,42,0.98));
        border-radius: 24px;
        box-shadow:
            0 24px 60px rgba(15,23,42,0.8),
            0 0 0 1px rgba(148,163,184,0.2);
        padding: 20px 24px 24px;
        backdrop-filter: blur(18px);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid rgba(148,163,184,0.3);
        padding-bottom: 10px;
    }
    header h1 {
        font-size: 20px;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        letter-spacing: 0.04em;
    }
    header h1 span.logo {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #e5e7eb, #38bdf8 35%, #0f172a 70%);
        box-shadow: 0 0 20px rgba(56,189,248,0.7);
    }
    header small {
        font-size: 11px;
        color: var(--text-sub);
    }
    .badge {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid rgba(148,163,184,0.5);
        color: var(--text-sub);
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .badge-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: linear-gradient(135deg, #22c55e, #4ade80);
        box-shadow: 0 0 8px rgba(52,211,153,0.9);
    }
    main {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
        gap: 18px;
    }
    @media (max-width: 900px) {
        main { grid-template-columns: minmax(0,1fr); }
    }
    .card {
        background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
        border-radius: 18px;
        border: 1px solid var(--border);
        padding: 14px 14px 16px;
        box-shadow:
            0 14px 30px rgba(15,23,42,0.85),
            0 0 0 1px rgba(15,23,42,0.9) inset;
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
        overflow: hidden;
    }
    .card::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(circle at 0 0, rgba(56,189,248,0.09), transparent 55%);
        mix-blend-mode: screen;
        opacity: 0.7;
        pointer-events: none;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        position: relative;
        z-index: 1;
    }
    .card-header h2 {
        margin: 0;
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .card-header h2 span.icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #38bdf8, #0f172a 80%);
        box-shadow: 0 0 12px rgba(56,189,248,0.8);
        font-size: 12px;
    }
    .card-header small {
        color: var(--text-sub);
        font-size: 11px;
    }
    .field-label {
        font-size: 11px;
        color: var(--text-sub);
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
    }
    .field-label span.hint {
        font-size: 10px;
        opacity: 0.85;
    }
    textarea {
        width: 100%;
        min-height: 120px;
        max-height: 200px;
        resize: vertical;
        border-radius: 10px;
        border: 1px solid rgba(148,163,184,0.6);
        padding: 10px 12px;
        font-size: 13px;
        font-family: inherit;
        background: rgba(15,23,42,0.9);
        color: var(--text-main);
        outline: none;
        box-shadow: 0 0 0 1px rgba(15,23,42,0.9);
        transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(56,189,248,0.2), 0 0 0 1px rgba(15,23,42,0.9) inset;
        background: rgba(15,23,42,0.96);
    }
    textarea[readonly] {
        opacity: 0.95;
    }
    .image-drop {
        border-radius: 14px;
        border: 1px dashed rgba(148,163,184,0.7);
        padding: 10px 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        cursor: pointer;
        background: rgba(15,23,42,0.9);
        position: relative;
        overflow: hidden;
        transition: border-color 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
    }
    .image-drop:hover {
        border-style: solid;
        border-color: rgba(56,189,248,0.7);
        background: radial-gradient(circle at top left, rgba(56,189,248,0.06), rgba(15,23,42,0.95));
        box-shadow: 0 0 0 1px rgba(15,23,42,0.95) inset, 0 0 24px rgba(56,189,248,0.25);
    }
    .image-drop-icon {
        width: 32px;
        height: 32px;
        border-radius: 12px;
        background: radial-gradient(circle at 30% 20%, rgba(56,189,248,0.7), rgba(15,23,42,1));
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 20px rgba(15,23,42,0.9);
        flex-shrink: 0;
        font-size: 18px;
    }
    .image-drop-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-size: 12px;
    }
    .image-drop-text span.main {
        font-weight: 500;
    }
    .image-drop-text span.sub {
        font-size: 11px;
        color: var(--text-sub);
    }
    .image-drop input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }
    .status-line {
        font-size: 11px;
        color: var(--text-sub);
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: center;
    }
    .status-line strong {
        font-weight: 500;
        color: var(--accent);
    }
    .status-line .error {
        color: var(--danger);
    }
    .btn-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    button, .btn-link {
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,0.7);
        background: radial-gradient(circle at 30% 20%, rgba(56,189,248,0.16), rgba(15,23,42,1));
        color: var(--text-main);
        font-size: 12px;
        padding: 7px 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        outline: none;
        box-shadow: 0 10px 24px rgba(15,23,42,0.9);
        transition: transform 0.12s ease, box-shadow 0.12s ease, border 0.12s ease, background 0.12s ease, opacity 0.12s ease;
        text-decoration: none;
        white-space: nowrap;
    }
    button span.icon, .btn-link span.icon {
        font-size: 14px;
    }
    button.primary {
        border-color: rgba(56,189,248,0.9);
        background: radial-gradient(circle at 30% 20%, #38bdf8, #0f172a 80%);
        box-shadow:
            0 18px 35px rgba(15,23,42,0.95),
            0 0 22px rgba(56,189,248,0.7);
    }
    button:hover, .btn-link:hover {
        transform: translateY(-1px);
        box-shadow:
            0 18px 35px rgba(15,23,42,0.95),
            0 0 20px rgba(56,189,248,0.35);
        border-color: rgba(56,189,248,0.9);
    }
    button:active, .btn-link:active {
        transform: translateY(0);
        box-shadow: 0 10px 20px rgba(15,23,42,0.9);
    }
    button:disabled {
        opacity: 0.5;
        cursor: default;
        transform: none;
        box-shadow: 0 10px 18px rgba(15,23,42,0.9);
    }
    .btn-link {
        opacity: 0.4;
        pointer-events: none;
    }
    .btn-link.active {
        opacity: 1;
        pointer-events: auto;
    }
    .canvas-wrap {
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(148,163,184,0.5);
        background: radial-gradient(circle at top, rgba(15,23,42,0.9), #020617 60%);
        padding: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 250px;
        position: relative;
    }
    canvas {
        max-width: 100%;
        height: auto;
        display: block;
        border-radius: 10px;
        background: #020617;
    }
    .canvas-placeholder {
        font-size: 12px;
        color: var(--text-sub);
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
        justify-content: center;
    }
    .canvas-placeholder-icon {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        border: 1px dashed rgba(148,163,184,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.8;
    }
    .info-line {
        font-size: 10px;
        color: var(--text-sub);
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: center;
    }
    .info-pill {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,0.5);
        font-size: 10px;
        display: inline-flex;
        gap: 4px;
        align-items: center;
    }
    .info-pill span.dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: linear-gradient(135deg, #38bdf8, #22c55e);
    }
    footer {
        font-size: 10px;
        color: var(--text-sub);
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }
    footer span strong {
        font-weight: 500;
        color: var(--accent);
    }
</style>
</head>
<body>
<div class="app">
    <header>
        <div>
            <h1>
                <span class="logo"></span>
                ã‚¢ãƒ«ãƒ•ã‚¡ãƒãƒ£ãƒ³ãƒãƒ«ZIPåŸ‹ã‚è¾¼ã¿ãƒ„ãƒ¼ãƒ« ver4.0.0
            </h1>
            <small>é€æ˜åº¦255ã®ç”»åƒã«ã€ã»ã¨ã‚“ã©è¦‹ãŸç›®ã‚’å¤‰ãˆãšZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŸ‹ã‚è¾¼ã¿ï¼æŠ½å‡ºã—ã¾ã™ã€‚</small>
        </div>
        <div class="badge">
            <span class="badge-dot"></span>
            Î± 255 â†’ 255 âˆ’ (0ã€œ7) / 1ãƒ”ã‚¯ã‚»ãƒ« 3bit
        </div>
    </header>

    <main>
        <!-- å·¦ï¼šåŸ‹ã‚è¾¼ã¿ -->
        <section class="card">
            <div class="card-header">
                <div>
                    <h2><span class="icon">âœ</span> ZIPã‚’ç”»åƒã«åŸ‹ã‚è¾¼ã‚€</h2>
                    <small>é€æ˜åº¦ãŒã™ã¹ã¦255ã®ç”»åƒã®ã¿ä½¿ç”¨å¯èƒ½</small>
                </div>
            </div>

            <div>
                <div class="field-label">
                    <span>ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠ</span>
                    <span class="hint">æœ€å¤§ 2,097,151 ãƒã‚¤ãƒˆï¼ˆç†è«–å€¤ï¼‰ / ä»»æ„ã®ZIPãƒã‚¤ãƒŠãƒªã‚’åŸ‹ã‚è¾¼ã¿</span>
                </div>
                <label class="image-drop">
                    <div class="image-drop-icon">ğŸ“¦</div>
                    <div class="image-drop-text">
                        <span class="main">ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                        <span class="sub">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠï¼ˆã¾ãŸã¯ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰</span>
                    </div>
                    <input type="file" id="zipInput" accept=".zip,application/zip">
                </label>
                <div class="status-line" style="margin-top:6px;">
                    <span id="zipStatus">ZIPãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</span>
                </div>
            </div>

            <div>
                <div class="field-label">
                    <span>ç”»åƒã®é¸æŠ</span>
                    <span class="hint">PNGæ¨å¥¨ï¼ˆJPEGã‚‚å¯ï¼‰ / å®Œå…¨ä¸é€æ˜(Î±=255)ã®ã¿åŸ‹ã‚è¾¼ã¿å¯èƒ½</span>
                </div>
                <label class="image-drop">
                    <div class="image-drop-icon">ğŸ–¼</div>
                    <div class="image-drop-text">
                        <span class="main">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                        <span class="sub">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠï¼ˆã¾ãŸã¯ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰</span>
                    </div>
                    <input type="file" id="imageInput" accept="image/*">
                </label>
            </div>

            <div class="status-line">
                <span id="imageStatus">ç”»åƒã¯ã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</span>
                <span id="capacityInfo">æ ¼ç´å¯èƒ½æ–‡å­—æ•°: 0 æ–‡å­—</span>
            </div>

            <div class="btn-row">
                <button class="primary" id="embedButton">
                    <span class="icon">â—†</span> æ–‡ç« ã‚’åŸ‹ã‚è¾¼ã‚“ã§ç”»åƒã‚’ç”Ÿæˆ
                </button>
                <a id="downloadLink" class="btn-link" href="#" download="embedded.png">
                    <span class="icon">â¬‡</span> åŸ‹ã‚è¾¼ã¿æ¸ˆã¿ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>

            <div class="info-line">
                <span id="encodeStatus">ZIPã¨ç”»åƒã‚’é¸æŠã—ã¦ã€Œæ–‡ç« ã‚’åŸ‹ã‚è¾¼ã‚“ã§ç”»åƒã‚’ç”Ÿæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>
                <span class="info-pill">
                    <span class="dot"></span>
                    <span>å…ˆé ­ 7 ãƒ”ã‚¯ã‚»ãƒ«ã«ãƒã‚¤ãƒˆæ•° / æ®‹ã‚Šã«ZIPæœ¬ä½“ã‚’æ ¼ç´</span>
                </span>
            </div>
        </section>

        <!-- å³ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & æŠ½å‡º -->
        <section class="card">
            <div class="card-header">
                <div>
                    <h2><span class="icon">ğŸ”</span> åŸ‹ã‚è¾¼ã¿ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æ–‡ç« æŠ½å‡º</h2>
                    <small>å‡ºåŠ›ç”»åƒã‚’èª­ã¿è¾¼ã‚ã°ã€åŸ‹ã‚è¾¼ã‚“ã æ–‡ç« ã‚’å¾©å…ƒã§ãã¾ã™ã€‚</small>
                </div>
            </div>

            <div class="canvas-wrap">
                <canvas id="canvas"></canvas>
                <div id="canvasPlaceholder" class="canvas-placeholder">
                    <div class="canvas-placeholder-icon">â—†</div>
                    <div>ã“ã“ã«ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
                    <div style="font-size:11px;">åŸ‹ã‚è¾¼ã¿å‰ã®ç¢ºèªã«ã‚‚ã€æŠ½å‡ºæ™‚ã®èª­ã¿è¾¼ã¿ã«ã‚‚åŒã˜ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</div>
                </div>
            </div>

            <div class="status-line">
                <span id="canvasInfo">ã‚­ãƒ£ãƒ³ãƒã‚¹æœªä½¿ç”¨</span>
                <span id="decodeStatus">ZIPæŠ½å‡ºã¯ã¾ã è¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</span>
            </div>

            <div>
                <div class="field-label">
                    <span>æ–‡ç« æŠ½å‡ºçµæœ</span>
                    <span class="hint">å³ä¸Šã®ã€ŒæŠ½å‡ºã€ãƒœã‚¿ãƒ³ã§ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ç”»åƒã‹ã‚‰æ–‡å­—åˆ—ã‚’å¾©å…ƒã—ã¾ã™ã€‚</span>
                </div>
                <textarea id="outputText" readonly placeholder="ã“ã“ã«æŠ½å‡ºã—ãŸZIPã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"></textarea>
            </div>

            <div class="btn-row">
                <button id="extractButton">
                    <span class="icon">ğŸ”</span> ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ç”»åƒã‹ã‚‰ZIPã‚’æŠ½å‡º
                </button>
                <button id="copyExtractedButton">
                    <span class="icon">â¬‡</span> æŠ½å‡ºã—ãŸZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </section>
    </main>

    <footer>
        <span>é€æ˜åº¦ãƒã‚§ãƒƒã‚¯: <strong>åŸ‹ã‚è¾¼ã¿æ™‚</strong> ã«å…¨ãƒ”ã‚¯ã‚»ãƒ« Î±=255 ã‹æ¤œè¨¼ã—ã¾ã™ã€‚</span>
        <span>1ãƒ”ã‚¯ã‚»ãƒ«ã‚ãŸã‚Š <strong>3bit (=8çŠ¶æ…‹)</strong> / ç”»åƒã‚µã‚¤ã‚ºã«å¿œã˜ã¦æœ€å¤§æ–‡å­—æ•°ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚</span>
    </footer>
</div>

<script>
(function() {
// ã‚¢ãƒ«ãƒ•ã‚¡å€¤ diffï¼ˆ255 - Î±ï¼‰ç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«
// 0ã€œ9 ã®ã†ã¡ 2,7 ã¯ãƒ€ãƒŸãƒ¼ç”¨ã«äºˆç´„ã—ã€æ®‹ã‚Šã§ 3bit(0ã€œ7) ã‚’è¡¨ç¾
const DIFF_TABLE = [0, 1, 3, 4, 5, 6, 8, 9]; // æœ‰åŠ¹å€¤
const INVALID_DIFF_1 = 2; // Î± = 253
const INVALID_DIFF_2 = 7; // Î± = 248

const RESERVED_HEADER_PIXELS = 7; // å…ˆé ­7ãƒ”ã‚¯ã‚»ãƒ«ã§æ–‡å­—æ•°(21bit)
const DUMMY_RATIO = 0.1;          // ãƒ€ãƒŸãƒ¼(248/253)ã‚’å…¥ã‚Œã‚‹æœ€å¤§å‰²åˆï¼ˆ10%ï¼‰

const zipInput = document.getElementById('zipInput');
    const imageInput = document.getElementById('imageInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const canvasPlaceholder = document.getElementById('canvasPlaceholder');


    const outputText = document.getElementById('outputText');
const zipStatus = document.getElementById('zipStatus');

    const embedButton = document.getElementById('embedButton');
    const extractButton = document.getElementById('extractButton');
    const copyExtractedButton = document.getElementById('copyExtractedButton');
    const downloadLink = document.getElementById('downloadLink');

    const imageStatus = document.getElementById('imageStatus');
    const capacityInfo = document.getElementById('capacityInfo');
    const encodeStatus = document.getElementById('encodeStatus');
    const decodeStatus = document.getElementById('decodeStatus');
    const canvasInfo = document.getElementById('canvasInfo');

    let originalImage = null;      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”Ÿç”»åƒ
    let originalImageData = null;  // Î±=255ç¢ºèªæ¸ˆã¿ã®å…ƒImageData
    let zipBytes = null;           // èª­ã¿è¾¼ã‚“ã ZIPã®ä¸­èº«ï¼ˆUint8Arrayï¼‰
    window.lastZipBlob = null;     // æŠ½å‡ºæ¸ˆã¿ZIP Blob
    window.lastZipUrl  = null;     // æŠ½å‡ºæ¸ˆã¿ZIPã®Object URL

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function updateCanvasPlaceholder() {
        if (canvas.width > 0 && canvas.height > 0) {
            canvasPlaceholder.style.display = 'none';
        } else {
            canvasPlaceholder.style.display = 'flex';
        }
    }

// ç”»åƒã‹ã‚‰æœ€å¤§æ ¼ç´æ–‡å­—æ•°ã‚’è¨ˆç®—
function updateCapacityInfo() {
    if (!originalImageData) {
        capacityInfo.textContent = 'æ ¼ç´å¯èƒ½ãƒã‚¤ãƒˆæ•°: 0 ãƒã‚¤ãƒˆ';
        return;
    }
    const totalPixels = originalImageData.width * originalImageData.height;

    if (totalPixels <= RESERVED_HEADER_PIXELS) {
        capacityInfo.textContent = 'æ ¼ç´å¯èƒ½ãƒã‚¤ãƒˆæ•°: 0 ãƒã‚¤ãƒˆï¼ˆç”»åƒãŒå°ã•ã™ãã¾ã™ï¼‰';
        return;
    }

    const availablePixels = totalPixels - RESERVED_HEADER_PIXELS; // ãƒ˜ãƒƒãƒ€ä»¥å¤–
    const maxDummyPixels = Math.floor(availablePixels * DUMMY_RATIO);
    const effectivePixels = availablePixels - maxDummyPixels; // å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã«ä½¿ã†ãƒ”ã‚¯ã‚»ãƒ«æ•°
    const capacityBits = effectivePixels * 3;                  // 1ãƒ”ã‚¯ã‚»ãƒ«3bit
    const maxBytes = Math.floor(capacityBits / 8);             // 1ãƒã‚¤ãƒˆ8bit

    capacityInfo.textContent = 'æ ¼ç´å¯èƒ½ãƒã‚¤ãƒˆæ•°: ' + maxBytes + ' ãƒã‚¤ãƒˆï¼ˆãƒ€ãƒŸãƒ¼åŸ‹ã‚è¾¼ã¿ã‚’è€ƒæ…®ã—ãŸæ¦‚ç®—ï¼‰';

}

    // ZIPèª­ã¿è¾¼ã¿
    zipInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) {
            zipBytes = null;
            zipStatus.textContent = 'ZIPãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(ev) {
            const buffer = ev.target.result;
            zipBytes = new Uint8Array(buffer);
            zipStatus.textContent =
                'ZIPèª­ã¿è¾¼ã¿æ¸ˆã¿: ' + file.name + ' / ' + zipBytes.length + ' ãƒã‚¤ãƒˆ';
        };
        reader.readAsArrayBuffer(file);
    });




    // ç”»åƒèª­ã¿è¾¼ã¿
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(ev) {
            const img = new Image();
            img.onload = function() {
                originalImage = img;
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                imageStatus.textContent = 'ç”»åƒèª­ã¿è¾¼ã¿æ¸ˆã¿: ' + img.width + ' Ã— ' + img.height + ' px';
                canvasInfo.textContent = 'ã‚­ãƒ£ãƒ³ãƒã‚¹: ' + img.width + ' Ã— ' + img.height + ' px (ã‚ªãƒªã‚¸ãƒŠãƒ«è¡¨ç¤ºä¸­)';
                encodeStatus.textContent = 'ZIPã¨ç”»åƒã‚’é¸æŠã—ã¦ã€Œæ–‡ç« ã‚’åŸ‹ã‚è¾¼ã‚“ã§ç”»åƒã‚’ç”Ÿæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
                decodeStatus.textContent = 'å‡ºåŠ›ç”»åƒã‚’ã“ã“ã§è¡¨ç¤ºã—ãŸçŠ¶æ…‹ã§ZIPã‚’æŠ½å‡ºã§ãã¾ã™ã€‚';


                updateCapacityInfo();
                updateCanvasPlaceholder();
                downloadLink.classList.remove('active');
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    });

    // Î±=255ã®ãƒã‚§ãƒƒã‚¯ï¼ˆåŸ‹ã‚è¾¼ã¿æ™‚ã®ã¿ä½¿ç”¨ï¼‰
    function checkAllAlphaFull(imageData) {
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const a = data[i + 3];
            if (a !== 255) {
                return false;
            }
        }
        return true;
    }

// æ–‡ç« åŸ‹ã‚è¾¼ã¿å‡¦ç†
embedButton.addEventListener('click', function() {
    if (!originalImageData) {
        alert('å…ˆã«ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
        return;
    }

    if (!zipBytes || zipBytes.length === 0) {
        alert('å…ˆã«åŸ‹ã‚è¾¼ã¿ãŸã„ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    // å…ˆé ­7ãƒ”ã‚¯ã‚»ãƒ«ï¼21bitã§è¡¨ç¾å¯èƒ½ãªç†è«–æœ€å¤§å€¤ã¯ 2^21 - 1 = 2,097,151 ãƒã‚¤ãƒˆ
    if (zipBytes.length > 2097151) {
        alert('ZIPãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ã€‚ç†è«–ä¸Šã®æœ€å¤§å€¤ 2,097,151 ãƒã‚¤ãƒˆã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚');
        return;
    }

    // Î±=255ãƒã‚§ãƒƒã‚¯
    if (!checkAllAlphaFull(originalImageData)) {
        alert('é€æ˜åº¦ãŒã™ã¹ã¦ 255 ã®ç”»åƒã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚\né€ééƒ¨åˆ†ã‚„åŠé€æ˜éƒ¨åˆ†ã‚’å«ã¾ãªã„ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    const width = originalImageData.width;
    const height = originalImageData.height;
    const totalPixels = width * height;
    if (totalPixels <= RESERVED_HEADER_PIXELS) {
        alert('ç”»åƒãŒå°ã•ã™ãã¾ã™ã€‚å…ˆé ­7ãƒ”ã‚¯ã‚»ãƒ«ã«æ–‡å­—æ•°ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã€ã‚‚ã£ã¨å¤§ããªç”»åƒã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    const availablePixels = totalPixels - RESERVED_HEADER_PIXELS;
    const maxDummyPixels = Math.floor(availablePixels * DUMMY_RATIO);
    const effectivePixels = availablePixels - maxDummyPixels;
    const capacityBits = effectivePixels * 3;     // å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã«ä½¿ãˆã‚‹ãƒ“ãƒƒãƒˆæ•°
    const neededBits = zipBytes.length * 8 + 21;

    if (neededBits > capacityBits) {
        alert('ã“ã®ç”»åƒã«ã¯ZIPã‚’æ ¼ç´ã—ãã‚Œã¾ã›ã‚“ã€‚\nï¼ˆãƒ€ãƒŸãƒ¼å€¤ã®åŸ‹ã‚è¾¼ã¿ã‚’è€ƒæ…®ã™ã‚‹ã¨å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã§ã™ï¼‰\nã‚‚ã£ã¨å¤§ããªç”»åƒã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’è¤‡è£½
    const encoded = ctx.createImageData(originalImageData);
    encoded.data.set(originalImageData.data);

    // ãƒ“ãƒƒãƒˆåˆ—ã‚’çµ„ã¿ç«‹ã¦ï¼ˆå…ˆé ­21bit:æ–‡å­—æ•° + æœ¬æ–‡ï¼‰
    const bits = [];
    const len = zipBytes.length;

    // å…ˆé ­21bit: ãƒã‚¤ãƒˆæ•° (0ã€œ2,097,151)
    for (let i = 20; i >= 0; i--) {
        bits.push((len >> i) & 1);
    }

    // æœ¬æ–‡: 1ãƒã‚¤ãƒˆ8bit
    for (let i = 0; i < zipBytes.length; i++) {
        const code = zipBytes[i] & 0xFF;
        for (let b = 7; b >= 0; b--) {
            bits.push((code >> b) & 1);
        }
    }

    const data = encoded.data;
    let bitIndex = 0;
    let dummyCount = 0;
    const maxDummy = maxDummyPixels;
    let dummy248Count = 0;
    let dummy253Count = 0;

    for (let p = 0; p < totalPixels; p++) {
        const alphaIndex = p * 4 + 3;

        // å…ˆé ­7ãƒ”ã‚¯ã‚»ãƒ«ã¯ãƒ˜ãƒƒãƒ€ï¼‹å…ˆé ­ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å¿…ãšæœ‰åŠ¹å€¤ã‚’ä½¿ã†ï¼ˆãƒ€ãƒŸãƒ¼ã¯å…¥ã‚Œãªã„ï¼‰
        if (p < RESERVED_HEADER_PIXELS) {
            let value = 0;
            for (let k = 0; k < 3; k++) {
                const bit = (bitIndex < bits.length) ? bits[bitIndex++] : 0;
                value = (value << 1) | bit;
            }
            const diff = DIFF_TABLE[value]; // 0ã€œ9ã®ã†ã¡ 2,7 ã‚’é¿ã‘ãŸå€¤
            data[alphaIndex] = 255 - diff;
            continue;
        }

        // ã“ã“ã‹ã‚‰å…ˆã¯ã€ãƒ“ãƒƒãƒˆãŒæ®‹ã£ã¦ã„ã‚‹é–“ã ã‘ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¯¾è±¡
        if (bitIndex < bits.length) {
            let useDummy = false;
            if (dummyCount < maxDummy) {
                // 10%ç¨‹åº¦ã®ç¢ºç‡ã§ãƒ€ãƒŸãƒ¼å€¤ã‚’æŒ¿å…¥ï¼ˆãŸã ã—ä¸Šé™ã¾ã§ï¼‰
                if (Math.random() < DUMMY_RATIO) {
                    useDummy = true;
                }
            }

            if (useDummy) {
                // ãƒ€ãƒŸãƒ¼å€¤: Î±=248 or 253ï¼ˆdiff=7 or 2ï¼‰ã‚’æ•£ã‚Šã°ã‚ã‚‹
                let alphaValue;
                if (dummy248Count === dummy253Count) {
                    // åŒæ•°ãªã‚‰ãƒ©ãƒ³ãƒ€ãƒ 
                    if (Math.random() < 0.5) {
                        alphaValue = 248;
                        dummy248Count++;
                    } else {
                        alphaValue = 253;
                        dummy253Count++;
                    }
                } else if (dummy248Count < dummy253Count) {
                    alphaValue = 248;
                    dummy248Count++;
                } else {
                    alphaValue = 253;
                    dummy253Count++;
                }
                data[alphaIndex] = alphaValue;
                dummyCount++;
            } else {
                // é€šå¸¸ã®3bitãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€
                let value = 0;
                for (let k = 0; k < 3; k++) {
                    const bit = (bitIndex < bits.length) ? bits[bitIndex++] : 0;
                    value = (value << 1) | bit;
                }
                const diff = DIFF_TABLE[value]; // 0ã€œ9ã®ã†ã¡ 2,7 ã‚’é¿ã‘ãŸå€¤
                data[alphaIndex] = 255 - diff;
            }
        } else {
            // ã‚‚ã†åŸ‹ã‚è¾¼ã‚€ãƒ“ãƒƒãƒˆãŒãªã„å ´åˆã¯ã€å…ƒã®Î±å€¤ã®ã¾ã¾æ”¾ç½®
            // ï¼ˆencoded.data ã¯ã™ã§ã« originalImageData.data ã‚’ã‚³ãƒ”ãƒ¼æ¸ˆã¿ï¼‰
        }
    }

    // å¿µã®ãŸã‚ã€å…¨ãƒ“ãƒƒãƒˆãŒä½¿ã„åˆ‡ã‚‰ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (bitIndex < bits.length) {
        alert('å†…éƒ¨ã‚¨ãƒ©ãƒ¼: ãƒ“ãƒƒãƒˆåˆ—ã‚’ã™ã¹ã¦åŸ‹ã‚è¾¼ã‚€å‰ã«ç”»åƒç¯„å›²ã‚’ä½¿ã„åˆ‡ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚è¨­å®šå€¤ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    (function convertDeliberately() {
        // 248 ã® 5% ã‚’ 253 ã«å¤‰æ›
        const convertCount = Math.floor(dummy248Count * 0.052);
        if (convertCount <= 0) return;

        let converted = 0;
        for (let p = RESERVED_HEADER_PIXELS; p < totalPixels; p++) {
            if (converted >= convertCount) break;

            const alphaIndex = p * 4 + 3;
            if (data[alphaIndex] === 248) {
                data[alphaIndex] = 253;
                converted++;
            }
        }
    })();

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã¸åæ˜ 
    ctx.putImageData(encoded, 0, 0);
    updateCanvasPlaceholder();

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’æœ‰åŠ¹åŒ–
    const url = canvas.toDataURL('image/png');
    downloadLink.href = url;
    downloadLink.download = 'embedded.png';
    downloadLink.classList.add('active');

    encodeStatus.textContent = 'ZIPã®åŸ‹ã‚è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‹ã‚‰ç”»åƒã‚’ä¿å­˜ã§ãã¾ã™ã€‚';
    canvasInfo.textContent = 'ã‚­ãƒ£ãƒ³ãƒã‚¹: ' + width + ' Ã— ' + height + ' px (åŸ‹ã‚è¾¼ã¿æ¸ˆã¿ç”»åƒè¡¨ç¤ºä¸­)';
    alert('ZIPã®åŸ‹ã‚è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‹ã‚‰ç”»åƒã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
});

// æŠ½å‡ºå‡¦ç†
extractButton.addEventListener('click', function() {
    if (!canvas.width || !canvas.height) {
        alert('å…ˆã«ç”»åƒã‚’èª­ã¿è¾¼ã‚€ã‹ã€åŸ‹ã‚è¾¼ã¿æ¸ˆã¿ç”»åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    const width = canvas.width;
    const height = canvas.height;
    const totalPixels = width * height;
    if (totalPixels < RESERVED_HEADER_PIXELS) {
        alert('ç”»åƒãŒå°ã•ã™ãã¦ã€åŸ‹ã‚è¾¼ã¾ã‚ŒãŸæƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã€‚');
        return;
    }

    const imageData = ctx.getImageData(0, 0, width, height);
    const data = imageData.data;

    // å…ˆé ­7ãƒ”ã‚¯ã‚»ãƒ«ï¼ˆ21bitï¼‰ã‹ã‚‰æ–‡å­—æ•°ã‚’å¾©å…ƒ
    const headerBits = [];
    for (let p = 0; p < RESERVED_HEADER_PIXELS; p++) {
        const alpha = data[p * 4 + 3];
        let diff = 255 - alpha;

        if (diff < 0) diff = 0;
        // ãƒ˜ãƒƒãƒ€ã«ãƒ€ãƒŸãƒ¼å€¤ãŒå‡ºã¦ããŸã‚‰ä¸æ­£
        if (diff === INVALID_DIFF_1 || diff === INVALID_DIFF_2) {
            alert('ãƒ˜ãƒƒãƒ€é ˜åŸŸã«ç„¡åŠ¹ãªå€¤ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            return;
        }

        const value = DIFF_TABLE.indexOf(diff);
        if (value === -1) {
            alert('ãƒ˜ãƒƒãƒ€ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            return;
        }

        for (let b = 2; b >= 0; b--) {
            headerBits.push((value >> b) & 1);
        }
    }

    // 21bit â†’ ãƒã‚¤ãƒˆæ•°
    let length = 0;
    for (let i = 0; i < 21; i++) {
        length = (length << 1) | (headerBits[i] || 0);
    }

    if (length === 0) {
        outputText.value = '';
        decodeStatus.textContent = 'ã‚µã‚¤ã‚º 0 ãƒã‚¤ãƒˆã®ãŸã‚ã€æŠ½å‡ºçµæœã¯ç©ºã§ã™ã€‚';
        alert('åŸ‹ã‚è¾¼ã¾ã‚ŒãŸZIPã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚µã‚¤ã‚º 0 ãƒã‚¤ãƒˆï¼‰ã€‚');
         
        return;
    }
    if (length > 2097151) {
        alert('ã‚µã‚¤ã‚ºæƒ…å ±ãŒä¸æ­£ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
        return;
    }

    const availablePixels = totalPixels - RESERVED_HEADER_PIXELS;
    const capacityBits = availablePixels * 3; // ä¸Šé™ãƒã‚§ãƒƒã‚¯ã¨ã—ã¦ã¯å¾“æ¥ã®ã¾ã¾ã§ååˆ†
    const neededBits = length * 8;
    if (neededBits > capacityBits) {
        alert('æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã‚µã‚¤ã‚ºæƒ…å ±ãŒã€ç”»åƒã®å®¹é‡ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
        return;
    }

    // æœ¬æ–‡ãƒ“ãƒƒãƒˆåˆ—ã‚’èª­ã¿å–ã‚Šï¼ˆãƒ€ãƒŸãƒ¼å€¤ã¯ç„¡è¦–ï¼‰: length ãƒã‚¤ãƒˆåˆ†
    const bitsNeeded = neededBits;
    const dataBits = [];
    for (let p = RESERVED_HEADER_PIXELS; p < totalPixels && dataBits.length < bitsNeeded; p++) {

        const alpha = data[p * 4 + 3];
        let diff = 255 - alpha;
        if (diff < 0) diff = 0;

        // ãƒ€ãƒŸãƒ¼å€¤(248,253)ã«å¯¾å¿œã™ã‚‹ diff=7,2 ã¯ã‚¹ã‚­ãƒƒãƒ—
        if (diff === INVALID_DIFF_1 || diff === INVALID_DIFF_2) {
            continue;
        }

        const value = DIFF_TABLE.indexOf(diff);
        if (value === -1) {
            alert('æœ¬æ–‡é ˜åŸŸã«ç„¡åŠ¹ãªå€¤ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            return;
        }

        for (let b = 2; b >= 0 && dataBits.length < bitsNeeded; b--) {
            dataBits.push((value >> b) & 1);
        }
    }

    if (dataBits.length < bitsNeeded) {
        alert('ç”»åƒã‹ã‚‰ååˆ†ãªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
         return;
    }

    // 8bit å˜ä½ã§ãƒã‚¤ãƒˆåˆ—å¾©å…ƒ
    const bytes = new Uint8Array(length);
    for (let i = 0; i < length; i++) {
        let code = 0;
        for (let b = 0; b < 8; b++) {
            code = (code << 1) | dataBits[i * 8 + b];
        }
        bytes[i] = code & 0xFF;
    }

    // æ—¢å­˜URLãŒã‚ã‚Œã°è§£æ”¾
    if (window.lastZipUrl) {
        try { URL.revokeObjectURL(window.lastZipUrl); } catch (e) {}
        window.lastZipUrl = null;
    }

    window.lastZipBlob = new Blob([bytes], { type: 'application/zip' });
    window.lastZipUrl  = URL.createObjectURL(window.lastZipBlob);

    outputText.value = 'ZIPã‚µã‚¤ã‚º: ' + length + ' ãƒã‚¤ãƒˆ ã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚';
    decodeStatus.textContent = 'ZIPã‚µã‚¤ã‚º ' + length + ' ãƒã‚¤ãƒˆã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚ã€ŒæŠ½å‡ºã—ãŸZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§ä¿å­˜ã§ãã¾ã™ã€‚';
    alert('ZIPã®æŠ½å‡ºãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
});


    // æŠ½å‡ºçµæœã‚³ãƒ”ãƒ¼
    copyExtractedButton.addEventListener('click', function() {
        if (!window.lastZipBlob || !window.lastZipUrl) {
            alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªZIPãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«æŠ½å‡ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚');
            return;
        }

        const a = document.createElement('a');
        a.href = window.lastZipUrl;
        a.download = 'extracted.zip';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });

    // åˆæœŸçŠ¶æ…‹
    updateCanvasPlaceholder();
    updateCapacityInfo();
})();
</script>
</body>
</html>
