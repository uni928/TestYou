<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>足元の変化お知らせカメラ（視覚障害者向けデモ）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #111;
    color: #fff;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    padding: 1rem;
    text-align: center;
    background: #222;
    font-size: 1.1rem;
  }
  main {
    flex: 1;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .video-wrapper {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    border-radius: 12px;
    overflow: hidden;
    border: 3px solid #444;
  }
  video {
    width: 100%;
    height: auto;
    background: #000;
  }
  .overlay-label {
    position: absolute;
    left: 0.5rem;
    top: 0.5rem;
    background: rgba(0,0,0,0.6);
    padding: 0.3rem 0.6rem;
    border-radius: 999px;
    font-size: 0.8rem;
  }
  .controls {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  button {
    font-size: 1.1rem;
    padding: 0.9rem 1rem;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    background: #0a84ff;
    color: #fff;
    font-weight: bold;
  }
  button.secondary {
    background: #444;
  }
  button.danger {
    background: #ff3b30;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .status {
    font-size: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    background: #222;
    border: 1px solid #333;
  }
  .status strong {
    display: inline-block;
    min-width: 5em;
  }
  .status-ok {
    color: #4cd964;
  }
  .status-warn {
    color: #ffcc00;
  }
  .status-err {
    color: #ff3b30;
  }
  details {
    max-width: 600px;
    margin: 0 auto;
    background: #181818;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    border: 1px solid #333;
    font-size: 0.9rem;
  }
  details summary {
    cursor: pointer;
    outline: none;
  }
  small {
    font-size: 0.8rem;
    color: #aaa;
  }
</style>
</head>
<body>
<header>
  足元の変化お知らせカメラ（デモ）
</header>

<main>
  <div class="video-wrapper" aria-label="カメラ映像のプレビュー">
    <span class="overlay-label">カメラ映像（足元を斜めに映してください）</span>
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div class="controls">
    <button id="startCameraBtn">① カメラを起動する</button>
    <button id="calibrateBtn" class="secondary" disabled>
      ② 今の地面を「いつもの状態」として登録
    </button>
    <button id="startDetectBtn" disabled>
      ③ 地面の色や白線などが変わったら音声で知らせる（開始）
    </button>
    <button id="stopDetectBtn" class="danger" disabled>
      停止
    </button>

    <div class="status" id="status">
      <div><strong>状態:</strong> <span id="stateText">待機中</span></div>
      <div><strong>解析:</strong> <span id="analyzeText">-</span></div>
      <div><strong>基準:</strong> <span id="thresholdText">未設定</span></div>
    </div>
  </div>

  <details>
    <summary>このページについて（注意事項と使い方）</summary>
    <p>
      このページは、スマートフォンなどのカメラを使って、<br>
      <strong>足元の地面を斜めに映しながら歩いたときに、白線が入る・地面の色が変わるなど「足元の景色が変わった」ときに、音声でお知らせする実験的なデモ</strong>です。
    </p>
    <p>
      カメラ画像の
      <ul>
        <li>全体の明るさ（色のトーン）</li>
        <li>白っぽい部分の量（白線などの可能性）</li>
      </ul>
      をざっくり計算し、最初に登録した状態から大きく変化したら「足元の景色が変わった」とみなしています。
    </p>
    <p><strong>重要：</strong></p>
    <ul>
      <li>実際の歩行時の安全確認には絶対に頼らないでください。</li>
      <li>段差・穴・人・車・ガラスなど、すべての危険を検出できるわけではありません。</li>
      <li>必ず白杖・ガイド・点字ブロックなど、正式な移動手段と併用してください。</li>
    </ul>
    <p><strong>使い方（想定）</strong></p>
    <ol>
      <li>「① カメラを起動する」をタップし、カメラ使用を許可します。</li>
      <li>カメラを<strong>足元の斜め前（少し先の地面）</strong>に向けます。</li>
      <li>いつもの地面の状態で、「② 今の地面を登録」を押します。</li>
      <li>「③ 足元の変化を検出（開始）」を押します。</li>
      <li>地面の色が変わったり、白線に近づくと、<br>
          「足元の景色が変わりました。段差や白線に注意してください。」と音声でお知らせします。</li>
    </ol>
    <p>
      iPhone / Android のブラウザでは、<strong>https で公開されたページ</strong>でないとカメラが動かない場合があります。
    </p>
    <p><small>※ソースコードはすべてブラウザ内で動作し、外部サーバーには画像を送信しません。</small></p>
  </details>

  <!-- 解析用の小さいキャンバス（画面には表示しない） -->
  <canvas id="analyzeCanvas" width="160" height="120" style="display:none;"></canvas>
</main>

<script>
  const video          = document.getElementById('video');
  const startCameraBtn = document.getElementById('startCameraBtn');
  const calibrateBtn   = document.getElementById('calibrateBtn');
  const startDetectBtn = document.getElementById('startDetectBtn');
  const stopDetectBtn  = document.getElementById('stopDetectBtn');

  const statusEl       = document.getElementById('status');
  const stateText      = document.getElementById('stateText');
  const analyzeText    = document.getElementById('analyzeText');
  const thresholdText  = document.getElementById('thresholdText');

  const canvas = document.getElementById('analyzeCanvas');
  const ctx    = canvas.getContext('2d');

  let stream = null;

  // 「いつもの足元」の基準
  let baseline = null; // { meanBrightness, stdBrightness, whiteRatio }
  // どれくらい変化したら「景色が変わった」とみなすか
  const colorDiffThreshold = 18;   // 明るさの変化量（0〜255）
  const whiteDiffThreshold = 0.08; // 白っぽい部分の割合差（0〜1）

  let detectTimer = null;
  let lastWarningTime = 0;
  const warningIntervalMs = 4000; // 4秒おきに最大1回だけ警告

  function setState(text, type = 'normal') {
    stateText.textContent = text;
    statusEl.classList.remove('status-ok', 'status-warn', 'status-err');
    if (type === 'ok')   statusEl.classList.add('status-ok');
    if (type === 'warn') statusEl.classList.add('status-warn');
    if (type === 'err')  statusEl.classList.add('status-err');
  }

  function speak(text) {
    try {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      speechSynthesis.cancel(); // 連続再生を防止
      speechSynthesis.speak(utter);
    } catch (e) {
      console.error(e);
    }
  }

  async function startCamera() {
    if (stream) return;
    try {
      setState('カメラ起動中…');
      startCameraBtn.disabled = true;

      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } },
        audio: false
      });
      video.srcObject = stream;

      setState('カメラ起動済み', 'ok');
      calibrateBtn.disabled   = false;
      startDetectBtn.disabled = false;
      speak('カメラを起動しました。足元の少し先の地面を映してから、今の地面を登録してください。');

    } catch (err) {
      console.error(err);
      setState('カメラを起動できませんでした。権限を確認してください。', 'err');
      analyzeText.textContent = 'カメラ権限が拒否されている可能性があります。';
      startCameraBtn.disabled = false;
      speak('カメラを起動できませんでした。設定からカメラの許可を確認してください。');
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
  }

  /**
   * 足元の特徴量を計算
   * - 画像全体を小さく縮小し、
   *   下側 60% を「地面」とみなして解析
   * - 明るさの平均・標準偏差・白っぽいピクセルの割合を返す
   */
  function computeGroundFeatures() {
    if (!video.videoWidth || !video.videoHeight) return null;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const w = canvas.width;
    const h = canvas.height;
    const imageData = ctx.getImageData(0, 0, w, h).data;

    // 足元は画面の下側にある前提で、下 60% を解析
    const xStart = 0;
    const xEnd   = w;
    const yStart = Math.floor(h * 0.4);
    const yEnd   = h;

    let sum = 0;
    let sumSq = 0;
    let count = 0;
    let whiteCount = 0;

    for (let y = yStart; y < yEnd; y++) {
      for (let x = xStart; x < xEnd; x++) {
        const idx = (y * w + x) * 4;
        const r = imageData[idx];
        const g = imageData[idx + 1];
        const b = imageData[idx + 2];

        // 明るさ（輝度）
        const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
        sum += brightness;
        sumSq += brightness * brightness;
        count++;

        // 白っぽいかどうか（白線などの検出用）
        // - 明るさが高い
        // - 彩度が低い（色味が少ない＝白〜グレー）
        const maxRGB = Math.max(r, g, b);
        const minRGB = Math.min(r, g, b);
        const diff = maxRGB - minRGB;
        const saturation = maxRGB === 0 ? 0 : diff / maxRGB;

        const isBright = brightness > 220;   // 明るい
        const isLowSat = saturation < 0.25;  // 彩度が低い
        if (isBright && isLowSat) {
          whiteCount++;
        }
      }
    }

    if (count === 0) return null;

    const mean = sum / count;
    const variance = sumSq / count - mean * mean;
    const stdDev = Math.sqrt(Math.max(variance, 0));
    const whiteRatio = whiteCount / count;  // 0〜1

    return { meanBrightness: mean, stdBrightness: stdDev, whiteRatio };
  }

  function calibrateGround() {
    const feat = computeGroundFeatures();
    if (!feat) {
      analyzeText.textContent = 'カメラ画像をまだ取得できていません。少し待ってください。';
      setState('キャリブレーション失敗', 'err');
      return;
    }
    baseline = feat;
    thresholdText.textContent =
      `明るさ基準: ${baseline.meanBrightness.toFixed(1)} / 白っぽさ基準: ${(baseline.whiteRatio * 100).toFixed(1)}%`;
    analyzeText.textContent =
      `現在の明るさ: ${feat.meanBrightness.toFixed(1)}, 白っぽさ: ${(feat.whiteRatio * 100).toFixed(1)}%`;
    setState('「いつもの足元」を登録しました', 'ok');
    speak('いつもの足元を登録しました。地面の色や白線の変化を検出します。');
  }

  function startDetect() {
    if (!stream) {
      setState('カメラが起動していません', 'err');
      speak('まずカメラを起動してください。');
      return;
    }
    if (!baseline) {
      // 基準がない場合は、自動的に今を基準として登録
      calibrateGround();
      if (!baseline) return;
    }
    if (detectTimer) return;

    detectTimer = setInterval(() => {
      const feat = computeGroundFeatures();
      if (!feat || !baseline) return;

      const meanDiff  = Math.abs(feat.meanBrightness - baseline.meanBrightness);
      const whiteDiff = feat.whiteRatio - baseline.whiteRatio;

      analyzeText.textContent =
        `明るさ: ${feat.meanBrightness.toFixed(1)} (差: ${meanDiff.toFixed(1)}), ` +
        `白っぽさ: ${(feat.whiteRatio * 100).toFixed(1)}% (差: ${(whiteDiff * 100).toFixed(1)}%)`;

      // 条件:
      // - 明るさが大きく変わった（地面の色が大きく変わった可能性）
      // - 白っぽい部分が増えた（白線・横断歩道などの可能性）
      const isColorChanged = meanDiff > colorDiffThreshold;
      const isWhiteIncreased = whiteDiff > whiteDiffThreshold;

      if (isColorChanged || isWhiteIncreased) {
        const now = Date.now();
        setState('足元の景色が変わった可能性があります', 'warn');

        if (now - lastWarningTime > warningIntervalMs) {
          lastWarningTime = now;
          speak('足元の景色が変わりました。段差や白線に注意してください。');
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]); // 端末が対応していれば振動
          }
        }
      } else {
        setState('特に大きな変化なし', 'ok');
      }
    }, 700); // 0.7秒ごとにチェック

    startDetectBtn.disabled = true;
    stopDetectBtn.disabled  = false;
    calibrateBtn.disabled   = false;
    setState('足元の変化を検出中…', 'ok');
    speak('足元の変化を検出しています。安全に注意して歩いてください。');
  }

  function stopDetect() {
    if (detectTimer) {
      clearInterval(detectTimer);
      detectTimer = null;
    }
    setState('検出停止中');
    startDetectBtn.disabled = false;
    stopDetectBtn.disabled  = true;
  }

  // ボタンイベント
  startCameraBtn.addEventListener('click', startCamera);
  calibrateBtn.addEventListener('click', calibrateGround);
  startDetectBtn.addEventListener('click', startDetect);
  stopDetectBtn.addEventListener('click', stopDetect);

  // ページを離れるときにカメラを停止
  window.addEventListener('beforeunload', () => {
    stopDetect();
    stopCamera();
  });
</script>
</body>
      </html>
