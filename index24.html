<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>簡易・壁接近お知らせカメラ（視覚障害者向けデモ）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #111;
    color: #fff;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    padding: 1rem;
    text-align: center;
    background: #222;
    font-size: 1.1rem;
  }
  main {
    flex: 1;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .video-wrapper {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    border-radius: 12px;
    overflow: hidden;
    border: 3px solid #444;
  }
  video {
    width: 100%;
    height: auto;
    background: #000;
  }
  .overlay-label {
    position: absolute;
    left: 0.5rem;
    top: 0.5rem;
    background: rgba(0,0,0,0.6);
    padding: 0.3rem 0.6rem;
    border-radius: 999px;
    font-size: 0.8rem;
  }
  .controls {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  button {
    font-size: 1.1rem;
    padding: 0.9rem 1rem;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    background: #0a84ff;
    color: #fff;
    font-weight: bold;
  }
  button.secondary {
    background: #444;
  }
  button.danger {
    background: #ff3b30;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .status {
    font-size: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    background: #222;
    border: 1px solid #333;
  }
  .status strong {
    display: inline-block;
    min-width: 5em;
  }
  .status-ok {
    color: #4cd964;
  }
  .status-warn {
    color: #ffcc00;
  }
  .status-err {
    color: #ff3b30;
  }
  details {
    max-width: 600px;
    margin: 0 auto;
    background: #181818;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    border: 1px solid #333;
    font-size: 0.9rem;
  }
  details summary {
    cursor: pointer;
    outline: none;
  }
  small {
    font-size: 0.8rem;
    color: #aaa;
  }
</style>
</head>
<body>
<header>
  簡易・壁接近お知らせカメラ（デモ）
</header>

<main>
  <div class="video-wrapper" aria-label="カメラ映像のプレビュー">
    <span class="overlay-label">カメラ映像</span>
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div class="controls">
    <button id="startCameraBtn">① カメラを起動する</button>
    <button id="calibrateBtn" class="secondary" disabled>
      ② 今の距離を「安全な距離」として登録
    </button>
    <button id="startDetectBtn" disabled>
      ③ 壁が近づいたら音声で知らせる（開始）
    </button>
    <button id="stopDetectBtn" class="danger" disabled>
      停止
    </button>

    <div class="status" id="status">
      <div><strong>状態:</strong> <span id="stateText">待機中</span></div>
      <div><strong>解析:</strong> <span id="analyzeText">-</span></div>
      <div><strong>しきい値:</strong> <span id="thresholdText">未設定</span></div>
    </div>
  </div>

  <details>
    <summary>このページについて（注意事項と使い方）</summary>
    <p>
      このページは、スマートフォンなどのカメラを使って、<br>
      <strong>画面の模様が単調になってきたら「前に壁があるかもしれない」と音声でお知らせする、実験的なデモ</strong>です。
    </p>
    <p>
      カメラ画像の「明るさのばらつき（凹凸や模様の量）」をざっくり分析し、<br>
      登録したときより単調になってきたら「壁が近づいた」とみなしています。
    </p>
    <p><strong>重要：</strong></p>
    <ul>
      <li>実際の歩行時の安全確認には絶対に頼らないでください。</li>
      <li>白杖・ガイド・点字ブロックなど、正式な移動手段を必ず併用してください。</li>
      <li>段差・人・車・ガラスなど、壁以外の危険は検出できません。</li>
    </ul>
    <p><strong>使い方（想定）</strong></p>
    <ol>
      <li>「① カメラを起動する」をタップし、カメラ使用を許可します。</li>
      <li>安全な距離で壁の方を向き、「② 今の距離を登録」を押します。</li>
      <li>「③ 壁が近づいたら音声で知らせる（開始）」を押します。</li>
      <li>壁にだんだん近づいていくと、<br>
          「前に壁があります。気をつけてください。」と音声で繰り返し知らせます。</li>
    </ol>
    <p>
      iPhone / Android のブラウザでは、<strong>https で公開されたページ</strong>でないとカメラが動かない場合があります。
    </p>
    <p><small>※ソースコードはすべてブラウザ内で動作し、外部サーバーには画像を送信しません。</small></p>
  </details>

  <!-- 解析用の小さいキャンバス（画面には表示しない） -->
  <canvas id="analyzeCanvas" width="160" height="120" style="display:none;"></canvas>
</main>

<script>
  const video          = document.getElementById('video');
  const startCameraBtn = document.getElementById('startCameraBtn');
  const calibrateBtn   = document.getElementById('calibrateBtn');
  const startDetectBtn = document.getElementById('startDetectBtn');
  const stopDetectBtn  = document.getElementById('stopDetectBtn');

  const statusEl       = document.getElementById('status');
  const stateText      = document.getElementById('stateText');
  const analyzeText    = document.getElementById('analyzeText');
  const thresholdText  = document.getElementById('thresholdText');

  const canvas = document.getElementById('analyzeCanvas');
  const ctx    = canvas.getContext('2d');

  let stream = null;
  let baselineStd = null;   // 「安全な距離」のときの明るさばらつき
  let thresholdRatio = 0.6; // これより単調(小さい)になると「壁接近」と判定
  let detectTimer = null;
  let lastWarningTime = 0;
  const warningIntervalMs = 4000; // 4秒おきに最大1回だけ警告

  function setState(text, type = 'normal') {
    stateText.textContent = text;
    statusEl.classList.remove('status-ok', 'status-warn', 'status-err');
    if (type === 'ok')   statusEl.classList.add('status-ok');
    if (type === 'warn') statusEl.classList.add('status-warn');
    if (type === 'err')  statusEl.classList.add('status-err');
  }

  function speak(text) {
    // 音声読み上げ（ブラウザの読み上げ機能）
    try {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      speechSynthesis.cancel(); // 連続再生を防止
      speechSynthesis.speak(utter);
    } catch (e) {
      console.error(e);
    }
  }

  async function startCamera() {
    if (stream) return;
    try {
      setState('カメラ起動中…');
      startCameraBtn.disabled = true;

      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } },
        audio: false
      });
      video.srcObject = stream;

      setState('カメラ起動済み', 'ok');
      calibrateBtn.disabled  = false;
      startDetectBtn.disabled = false;
      speak('カメラを起動しました。今の距離を登録してから、検出を開始してください。');

    } catch (err) {
      console.error(err);
      setState('カメラを起動できませんでした。権限を確認してください。', 'err');
      analyzeText.textContent = 'カメラ権限が拒否されている可能性があります。';
      startCameraBtn.disabled = false;
      speak('カメラを起動できませんでした。設定からカメラの許可を確認してください。');
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
  }

  function computeBrightnessStd() {
    if (!video.videoWidth || !video.videoHeight) return null;

    // 小さいキャンバスに縮小して描画（負荷軽減）
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const w = canvas.width;
    const h = canvas.height;
    const imageData = ctx.getImageData(0, 0, w, h).data;

    // 中央部分だけを使う（上下左右を少し切る）
    const xStart = Math.floor(w * 0.25);
    const xEnd   = Math.floor(w * 0.75);
    const yStart = Math.floor(h * 0.25);
    const yEnd   = Math.floor(h * 0.75);

    let sum = 0;
    let sumSq = 0;
    let count = 0;

    for (let y = yStart; y < yEnd; y++) {
      for (let x = xStart; x < xEnd; x++) {
        const idx = (y * w + x) * 4;
        const r = imageData[idx];
        const g = imageData[idx + 1];
        const b = imageData[idx + 2];
        // 輝度（簡易）
        const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
        sum += brightness;
        sumSq += brightness * brightness;
        count++;
      }
    }
    if (count === 0) return null;
    const mean = sum / count;
    const variance = sumSq / count - mean * mean;
    const stdDev = Math.sqrt(Math.max(variance, 0));
    return { mean, stdDev };
  }

  function calibrateBaseline() {
    const result = computeBrightnessStd();
    if (!result) {
      analyzeText.textContent = 'カメラ画像をまだ取得できていません。少し待ってください。';
      setState('キャリブレーション失敗', 'err');
      return;
    }
    baselineStd = result.stdDev;
    thresholdText.textContent = `基準${baselineStd.toFixed(1)} × ${thresholdRatio} ≒ ${(baselineStd * thresholdRatio).toFixed(1)}`;
    analyzeText.textContent = `現在の明るさばらつき: ${result.stdDev.toFixed(1)}`;
    setState('「安全な距離」を登録しました', 'ok');
    speak('安全な距離を登録しました。壁が近づいたときに音声でお知らせします。');
  }

  function startDetect() {
    if (!stream) {
      setState('カメラが起動していません', 'err');
      speak('まずカメラを起動してください。');
      return;
    }
    if (!baselineStd) {
      // 基準がない場合は、自動的に今を基準として登録
      calibrateBaseline();
      if (!baselineStd) return;
    }

    if (detectTimer) return;

    detectTimer = setInterval(() => {
      const result = computeBrightnessStd();
      if (!result) return;
      const { mean, stdDev } = result;

      analyzeText.textContent =
        `明るさ平均: ${mean.toFixed(1)} / ばらつき: ${stdDev.toFixed(1)}`;

      const threshold = baselineStd * thresholdRatio;

      // 「ばらつき」が基準より十分小さい → 模様が少ない → 近くの壁かも？
      if (stdDev < threshold) {
        const now = Date.now();
        setState('壁が近い可能性があります', 'warn');
        if (now - lastWarningTime > warningIntervalMs) {
          lastWarningTime = now;
          speak('前に壁があります。気をつけてください。');
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]); // 軽く振動（対応端末のみ）
          }
        }
      } else {
        setState('特に変化なし', 'ok');
      }
    }, 700); // 0.7秒ごとにチェック

    startDetectBtn.disabled = true;
    stopDetectBtn.disabled = false;
    calibrateBtn.disabled = false;
    setState('検出中…', 'ok');
    speak('壁の接近を検出しています。安全に注意して歩いてください。');
  }

  function stopDetect() {
    if (detectTimer) {
      clearInterval(detectTimer);
      detectTimer = null;
    }
    setState('検出停止中');
    startDetectBtn.disabled = false;
    stopDetectBtn.disabled = true;
  }

  // ボタンイベント
  startCameraBtn.addEventListener('click', startCamera);
  calibrateBtn.addEventListener('click', calibrateBaseline);
  startDetectBtn.addEventListener('click', startDetect);
  stopDetectBtn.addEventListener('click', stopDetect);

  // ページを離れるときにカメラを停止
  window.addEventListener('beforeunload', () => {
    stopDetect();
    stopCamera();
  });
</script>
</body>
</html>
