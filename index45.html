<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>視覚障がい者向け風景案内</title>
<style>
 body {
   margin: 0;
   font-family: sans-serif;
   background: #111;
   color: #fff;
   overflow: hidden;
 }
 #container {
   position: relative;
   width: 100vw;
   height: 100vh;
   display: flex;
   flex-direction: column;
   justify-content: center;
   align-items: center;
 }
 video {
   position: absolute;
   width: 100%;
   height: 100%;
   object-fit: cover;
   z-index: 1;
 }
 #overlay {
   position: absolute;
   bottom: 0;
   width: 100%;
   padding: 20px;
   background: rgba(0,0,0,0.5);
   z-index: 2;
   font-size: 1.2rem;
   line-height: 1.6;
 }
 #keyModal {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background: rgba(0,0,0,0.8);
   color: #fff;
   display: flex;
   justify-content: center;
   align-items: center;
   flex-direction: column;
   z-index: 10;
 }
 #keyModal input {
   width: 80%;
   padding: 12px;
   border-radius: 10px;
   margin-bottom: 20px;
   font-size: 1.1rem;
 }
 #keyModal button {
   padding: 12px 20px;
   font-size: 1.1rem;
   border-radius: 10px;
 }
</style>
</head>
<body>
<div id="keyModal">
  <h2>ChatGPT API Key を入力してください</h2>
  <input id="apiKeyInput" placeholder="sk-..." />
  <button onclick="saveKey()">保存して開始</button>
</div>
<div id="container" onclick="captureAndDescribe()">
  <video id="camera" autoplay playsinline></video>
  <div id="overlay">画面をタッチして風景を解析します…</div>
</div>
<script>
let apiKey = "";
let stream;
let speech = window.speechSynthesis;

async function loadKey() {
  const db = await openDB();
  // IndexedDB から保存済み API キーを取得
  const tx = db.transaction("kv", "readonly");
  const store = tx.objectStore("kv");
  const req = store.get("apiKey");
  const key = await new Promise(resolve => {
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => resolve(null);
  });

  // ▼ API キー未保存の場合、URL のクエリパラメータ ?key=xxxxx を確認
  if (!key) {
    const params = new URLSearchParams(window.location.search);
    const urlKey = params.get("key");

    if (urlKey) {
      // IndexedDB に保存
      const tx2 = db.transaction("kv", "readwrite");
      const store2 = tx2.objectStore("kv");
      await new Promise(resolve => {
        const putReq = store2.put(urlKey, "apiKey");
        putReq.onsuccess = () => resolve();
        putReq.onerror = () => resolve();
      });

      apiKey = urlKey;
      document.getElementById("keyModal").style.display = "none";
      startCamera();
      return;
    }
  }
  if (key) {
    apiKey = key;
    document.getElementById('keyModal').style.display = 'none';
    startCamera();
  }
}

async function saveKey() {
  const v = document.getElementById('apiKeyInput').value.trim();
  if (!v) return;
  const db = await openDB();
  const tx = db.transaction('kv', 'readwrite');
  const store = tx.objectStore('kv');
  await new Promise(resolve => {
    const req = store.put(v, 'apiKey');
    req.onsuccess = () => resolve();
    req.onerror = () => resolve();
  });
  apiKey = v;
  document.getElementById('keyModal').style.display = 'none';
  startCamera();
}

function openDB() {
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open('visionDB',1);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if (!db.objectStoreNames.contains('kv')) db.createObjectStore('kv');
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

async function startCamera() {
  try {
    // 背面カメラ（environment）を優先して取得
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" }
      }
    });
  } catch (e) {
    console.warn("背面カメラ取得に失敗したため、デフォルトカメラを使用します:", e);
    // 失敗した場合は従来通り（フォールバック）
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
  }

  const video = document.getElementById('camera');
  video.srcObject = stream;
}

async function captureAndDescribe() {
  if (!apiKey) {
    speak("まず ChatGPT の API キーを設定してください。");
    return;
  }

  const video = document.getElementById("camera");
  const overlay = document.getElementById("overlay");

  if (!video.videoWidth || !video.videoHeight) {
    overlay.textContent = "カメラの準備中です…もう一度タップしてください。";
    speak("カメラの準備中です。しばらく待ってからもう一度タップしてください。");
    return;
  }

  // 画像をキャプチャ
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  const dataUrl = canvas.toDataURL("image/jpeg");

  overlay.textContent = "周囲を分析しています…";
  speak("周囲を分析しています。少しお待ちください。");

  try {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-5-mini",
        messages: [
          {
            role: "system",
            content:
              "あなたは視覚障害者向けの道案内アシスタントです。" +
              "現在の映像をもとに、以下の点に必ず触れながら説明してください。" +
              "・左右（左・右）と前方の状況を簡潔に説明する\n" +
              "・どちらの方向に進むと安全かを優先して案内する\n" +
              "・距離の目安（例：2〜3メートル先）を可能な限り含める\n" +
              "・道の幅、曲がり角、横断歩道、階段、段差、植え込み、車、人などの障害物を明確に伝える\n" +
              "・危険がある場合は最初に警告する\n" +
              "・専門用語は使わず短い文で優しく案内する\n" +
              "・背景説明は不要で、道案内に必要な情報にしぼる"
          },
          {
            role: "user",
            content: [
              {
                type: "text",
                text:
                  "映像に基づいて、視覚障害者に向けて「今どちらの方向に進むと安全か」「左右前方に何があるか」を中心に、" +
                  "わかりやすく道案内をしてください。"
              },
              {
                type: "image_url",
                image_url: { url: dataUrl }  // 重要：形式はこれ
              }
            ]
          }
        ],
        reasoning_effort: "minimal",
        service_tier: "priority", // ←追加
      })
    });

    if (!response.ok) {
      const err = await response.text();
      console.error("API Error:", err);
      overlay.textContent = "情報を取得できませんでした。（エラー " + response.status + "）";
      speak("情報を取得できませんでした。あとでもう一度試してください。");
      return;
    }

    const json = await response.json();
    const text =
      json.choices?.[0]?.message?.content ||
      "情報を取得できませんでした。";

    overlay.textContent = text;
    speak(text);

  } catch (error) {
    console.error(error);
    overlay.textContent = "通信エラーが発生しました。ネットワークを確認してください。";
    speak("通信エラーが発生しました。ネットワークを確認してください。");
  }
}



function speak(text) {
  if (!speech) return;
  speech.cancel();
  const ut = new SpeechSynthesisUtterance(text);
  ut.lang = 'ja-JP';
  ut.rate = 2.0;   // ★ 追加：読み上げ速度を2倍にする
  speech.speak(ut);
}

loadKey();
</script>
</body>
</html>
