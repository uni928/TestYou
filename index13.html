<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>フリック練習ツール（事前登録版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --bg: #f4f4f4;
    --fg: #222;
    --accent: #007aff;
    --accent-soft: rgba(0,122,255,0.12);
    --border: #ddd;
    --danger: #f53d3d;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--fg);
  }
  .app {
    max-width: 640px;
    margin: 0 auto;
    padding: 12px 12px 32px;
  }
  h1 {
    font-size: 1.3rem;
    margin: 8px 0 12px;
    text-align: center;
  }
  h2 {
    font-size: 1.05rem;
    margin: 16px 0 8px;
  }
  .card {
    background: #fff;
    border-radius: 12px;
    padding: 12px;
    margin-top: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    border: 1px solid var(--border);
  }
  .btn-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  button {
    padding: 8px 12px;
    border-radius: 999px;
    border: none;
    font-size: 0.9rem;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
  }
  button.secondary {
    background: #eee;
    color: #333;
  }
  button:disabled {
    opacity: 0.5;
    cursor: default;
  }
  .info {
    font-size: 0.8rem;
    color: #666;
    margin-top: 4px;
  }
  .small {
    font-size: 0.8rem;
  }
  .list {
    margin-top: 6px;
    font-size: 0.8rem;
  }
  .list-item {
    padding: 2px 0;
  }
  .status {
    margin-top: 6px;
    font-size: 0.85rem;
    min-height: 1.2em;
  }
  .status.ok { color: #0a9d3f; }
  .status.ng { color: var(--danger); }
  .divider {
    margin: 10px 0;
    height: 1px;
    background: var(--border);
  }

  /* 擬似キーボード */
  .keyboard-wrapper {
    margin-top: 8px;
  }
  .keyboard-title {
    font-size: 0.9rem;
    margin-bottom: 4px;
  }
  .keyboard {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 8px;
    touch-action: none;
  }
  .key {
    background: #fafafa;
    border-radius: 12px;
    border: 1px solid var(--border);
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-size: 1.1rem;
    user-select: none;
    position: relative;
  }
  .key-label-main {
    font-size: 1.2rem;
  }
  .key-label-sub {
    font-size: 0.6rem;
    opacity: 0.7;
    position: absolute;
    bottom: 4px;
    right: 6px;
  }
  .key-arrows {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 2px;
  }
  .key.guide {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }
/* ★追加：ガイド枠を方向に応じて少しズラす */
  .key.guide-up    { transform: translateY(-20px); }
  .key.guide-down  { transform: translateY( 20px); }
  .key.guide-left  { transform: translateX(-20px); }
  .key.guide-right { transform: translateX( 20px); }
  .key.guide-center{ transform: scale(1.03); }
  .current-word {
    font-size: 1.1rem;
    font-weight: 600;
    margin-top: 4px;
  }
  .step-progress {
    font-size: 0.85rem;
    margin-top: 2px;
  }
  .guide-text {
    font-size: 0.9rem;
    margin-top: 4px;
  }
  .pattern-list {
    margin-top: 6px;
    font-size: 0.8rem;
  }
  .pattern-step {
    display: inline-block;
    margin: 2px 2px;
    padding: 2px 6px;
    border-radius: 999px;
    background: #f0f0f0;
  }
  .mapping-table {
    margin-top: 6px;
    font-size: 0.8rem;
    border-collapse: collapse;
    width: 100%;
  }
  .mapping-table th,
  .mapping-table td {
    border: 1px solid var(--border);
    padding: 2px 4px;
    text-align: center;
  }
  .mapping-table th {
    background: #fafafa;
  }
</style>
</head>
<body>
<div class="app">
  <h1>フリック練習ツール（事前登録版）</h1>

  <!-- 0. 登録済み単語の一覧表示 -->
  <div class="card">
    <h2>登録済み単語</h2>
    <div class="info">
      単語はあらかじめコード内で登録されています。<br>
      「ランダムに出題」を押して、擬似キーボードでフリック練習をします。
    </div>
    <div class="list" id="wordListArea">
      （読み込み中…）
    </div>
  </div>

  <!-- 擬似キーボード -->
  <div class="card keyboard-wrapper">
    <div class="keyboard-title">
      擬似フリックキーボード
      <span class="small">（キーの矢印の向きにスライド）</span>
    </div>
    <div class="keyboard" id="keyboard">
      <div class="key" data-key-id="a">
        <span class="key-label-main">あ</span>
        <span class="key-arrows">← ↑ → ↓</span>
        <span class="key-label-sub">あ行</span>
      </div>
      <div class="key" data-key-id="ka">
        <span class="key-label-main">か</span>
        <span class="key-arrows">← ↑ → ↓</span>
        <span class="key-label-sub">か行</span>
      </div>
      <div class="key" data-key-id="sa">
        <span class="key-label-main">さ</span>
        <span class="key-arrows">← ↑ → ↓</span>
        <span class="key-label-sub">さ行</span>
      </div>

      <div class="key" data-key-id="ta">
        <span class="key-label-main">た</span>
        <span class="key-arrows">← ↑ → ↓</span>
        <span class="key-label-sub">た行</span>
      </div>
      <div class="key" data-key-id="na">
        <span class="key-label-main">な</span>
        <span class="key-arrows">← ↑ → ↓</span>
        <span class="key-label-sub">な行</span>
      </div>
      <div class="key" data-key-id="ha">
        <span class="key-label-main">は</span>
        <span class="key-arrows">← ↑ → ↓</span>
        <span class="key-label-sub">は行</span>
      </div>

      <div class="key" data-key-id="ma">
        <span class="key-label-main">ま</span>
        <span class="key-arrows">← ↑ → ↓</span>
        <span class="key-label-sub">ま行</span>
      </div>
      <div class="key" data-key-id="ya">
        <span class="key-label-main">や</span>
        <span class="key-arrows">↑ ↓</span>
        <span class="key-label-sub">や行</span>
      </div>
      <div class="key" data-key-id="ra">
        <span class="key-label-main">ら</span>
        <span class="key-arrows">← ↑ → ↓</span>
        <span class="key-label-sub">ら行</span>
      </div>

      <div class="key" data-key-id="wa">
        <span class="key-label-main">わ</span>
        <span class="key-arrows">↑ →</span>
        <span class="key-label-sub">わ行</span>
      </div>
      <div class="key" data-key-id="space">
        <span class="key-label-main">空白</span>
        <span class="key-label-sub">space</span>
      </div>
      <div class="key" data-key-id="del">
        <span class="key-label-main">削除</span>
        <span class="key-label-sub">del</span>
      </div>
    </div>
  </div>

  <!-- 2. ランダム出題で練習 -->
  <div class="card">
    <h2>ランダム出題で練習</h2>
    <div class="btn-row">
      <button id="startPracticeBtn" disabled>ランダムに出題</button>
      <button id="stopPracticeBtn" class="secondary" disabled>練習を終了</button>
    </div>
    <div class="divider"></div>
    <div class="current-word" id="currentWord">（まだ出題されていません）</div>
    <div class="step-progress" id="stepProgress"></div>
    <div class="guide-text" id="guideText"></div>
    <div class="status" id="practiceStatus"></div>
    <div class="pattern-list">
      <div class="small">この単語のフリック手順：</div>
      <div id="practiceStepsArea" class="small">（出題中のみ表示されます）</div>
    </div>
  </div>

  <!-- 3. フリック表（参考用） -->
  <div class="card">
    <h2>フリック対応表（内部で使用）</h2>
    <div class="info">
      例：<code>{"い": {key:"あ", dir:"←"}}</code>、<code>{"う": {key:"あ", dir:"↑"}}</code> など。
    </div>
    <table class="mapping-table" id="mappingTable">
      <thead>
        <tr><th>文字</th><th>キー</th><th>方向</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
(function () {
  // ---- フリック対応表 ----
  // direction: "center" | "left" | "right" | "up" | "down"
  const flickTable = {
    // あ行
    "あ": { keyId: "a", direction: "center" },
    "い": { keyId: "a", direction: "left"   },
    "う": { keyId: "a", direction: "up"     },
    "え": { keyId: "a", direction: "right"  },
    "お": { keyId: "a", direction: "down"   },

    // か行
    "か": { keyId: "ka", direction: "center" },
    "き": { keyId: "ka", direction: "left"   },
    "く": { keyId: "ka", direction: "up"     },
    "け": { keyId: "ka", direction: "right"  },
    "こ": { keyId: "ka", direction: "down"   },

    // さ行
    "さ": { keyId: "sa", direction: "center" },
    "し": { keyId: "sa", direction: "left"   },
    "す": { keyId: "sa", direction: "up"     },
    "せ": { keyId: "sa", direction: "right"  },
    "そ": { keyId: "sa", direction: "down"   },

    // た行
    "た": { keyId: "ta", direction: "center" },
    "ち": { keyId: "ta", direction: "left"   },
    "つ": { keyId: "ta", direction: "up"     },
    "て": { keyId: "ta", direction: "right"  },
    "と": { keyId: "ta", direction: "down"   },

    // な行
    "な": { keyId: "na", direction: "center" },
    "に": { keyId: "na", direction: "left"   },
    "ぬ": { keyId: "na", direction: "up"     },
    "ね": { keyId: "na", direction: "right"  },
    "の": { keyId: "na", direction: "down"   },

    // は行
    "は": { keyId: "ha", direction: "center" },
    "ひ": { keyId: "ha", direction: "left"   },
    "ふ": { keyId: "ha", direction: "up"     },
    "へ": { keyId: "ha", direction: "right"  },
    "ほ": { keyId: "ha", direction: "down"   },

    // ま行
    "ま": { keyId: "ma", direction: "center" },
    "み": { keyId: "ma", direction: "left"   },
    "む": { keyId: "ma", direction: "up"     },
    "め": { keyId: "ma", direction: "right"  },
    "も": { keyId: "ma", direction: "down"   },

    // や行（左右は未使用）
    "や": { keyId: "ya", direction: "center" },
    "ゆ": { keyId: "ya", direction: "up"     },
    "よ": { keyId: "ya", direction: "down"   },

    // ら行
    "ら": { keyId: "ra", direction: "center" },
    "り": { keyId: "ra", direction: "left"   },
    "る": { keyId: "ra", direction: "up"     },
    "れ": { keyId: "ra", direction: "right"  },
    "ろ": { keyId: "ra", direction: "down"   },

    // わ行（簡易仕様）
    "わ": { keyId: "wa", direction: "center" },
    "を": { keyId: "wa", direction: "up"     },
    "ん": { keyId: "wa", direction: "right"  }
  };

  const dirText = {
    center: "タップ",
    left: "左フリック",
    right: "右フリック",
    up: "上フリック",
    down: "下フリック"
  };
  const dirArrow = {
    center: "・",
    left: "←",
    right: "→",
    up: "↑",
    down: "↓"
  };

  // ★追加：キーごとの矢印配置（どの方向が有効か）
  function getDirsForKey(keyId) {
    if (["a","ka","sa","ta","na","ha","ma","ra"].includes(keyId)) {
      return ["left","up","right","down"];
    }
    if (keyId === "ya") return ["up","down"];
    if (keyId === "wa") return ["up","right"];
    return null; // space / del など
  }

  // ★追加：全キーの矢印表示を更新（指定されたキー＋方向だけ強調）
  function updateAllKeyArrows(activeKeyId, activeDir) {
    keyElements.forEach(k => {
      const keyId = k.dataset.keyId;
      const arrowsEl = k.querySelector(".key-arrows");
      if (!arrowsEl) return;

      const dirs = getDirsForKey(keyId);
      if (!dirs) {
        // space / del などは何もしない
        return;
      }

      const parts = dirs.map(dir => {
        const arrowChar = dirArrow[dir];
        if (activeKeyId === keyId && activeDir === dir) {
          // 今やるべき矢印だけ [↑] のように強調
          return "[" + arrowChar + "]";
        }
        return arrowChar;
      });

      arrowsEl.textContent = parts.join(" ");
    });
  }

  // ---- 事前登録する単語 ----
  const initialWords = [
    "こんにちは",
    "おはよう",
    "さようなら",
    "すし",
    "いぬ",
    "ねこ",
    "やま",
    "かわ",
    "らいおん",
    "まつり"
  ];

  // ---- 状態 ----
  const MODE_IDLE = "idle";
  const MODE_PRACTICE = "practice";
  let mode = MODE_IDLE;

  const patterns = []; // {id, word, steps:[{char, keyId, direction}]}
  let currentPattern = null;
  let currentStepIndex = 0;

  let pointerState = null; // {id, keyId, startX, startY}

  // ---- 要素取得 ----
  const wordListArea = document.getElementById("wordListArea");

  const keyboard = document.getElementById("keyboard");
  const keyElements = Array.from(keyboard.querySelectorAll(".key"));

  const startPracticeBtn = document.getElementById("startPracticeBtn");
  const stopPracticeBtn = document.getElementById("stopPracticeBtn");
  const currentWordEl = document.getElementById("currentWord");
  const stepProgressEl = document.getElementById("stepProgress");
  const guideTextEl = document.getElementById("guideText");
  const practiceStatusEl = document.getElementById("practiceStatus");
  const practiceStepsArea = document.getElementById("practiceStepsArea");

  const mappingTableBody = document.querySelector("#mappingTable tbody");

  // ---- フリック表をテーブルに展開 ----
  function getKeyLabel(keyId) {
    const el = keyElements.find(k => k.dataset.keyId === keyId);
    if (!el) return keyId;
    return el.querySelector(".key-label-main").textContent;
  }

  function renderMappingTable() {
    const entries = Object.entries(flickTable);
    entries.sort((a, b) => a[0].localeCompare(b[0]));
    mappingTableBody.innerHTML = "";
    for (const [ch, info] of entries) {
      const tr = document.createElement("tr");
      const keyLabel = getKeyLabel(info.keyId);
      const td1 = document.createElement("td");
      const td2 = document.createElement("td");
      const td3 = document.createElement("td");
      td1.textContent = ch;
      td2.textContent = keyLabel;
      td3.textContent = dirText[info.direction] + "（" + dirArrow[info.direction] + "）";
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      mappingTableBody.appendChild(tr);
    }
  }

  // ---- 単語 → フリック手順 ----
  function wordToSteps(word) {
    const chars = Array.from(word);
    const steps = [];
    const unknown = new Set();
    for (const ch of chars) {
      const info = flickTable[ch];
      if (!info) {
        if (ch.trim() !== "") unknown.add(ch);
        continue;
      }
      steps.push({
        char: ch,
        keyId: info.keyId,
        direction: info.direction
      });
    }
    return { steps, unknown: Array.from(unknown) };
  }

  // ---- 単語一覧の表示 ----
  function updateWordList() {
    const count = patterns.length;
    if (count === 0) {
      wordListArea.innerHTML = "<span class=\"small\">登録済み単語：0件（対応外の文字のみでした）</span>";
      startPracticeBtn.disabled = true;
      return;
    }
    startPracticeBtn.disabled = false;

    const wrapper = document.createElement("div");
    wrapper.className = "small";

    const label = document.createElement("div");
    label.textContent = "登録済み単語：" + count + "件";
    wrapper.appendChild(label);

    patterns.forEach(p => {
      const item = document.createElement("div");
      item.className = "list-item";
      item.textContent = "・" + p.word + "（ステップ数 " + p.steps.length + "）";
      wrapper.appendChild(item);
    });

    wordListArea.innerHTML = "";
    wordListArea.appendChild(wrapper);
  }

  // ---- 初期単語をパターン化して登録 ----
  function initPatternsFromInitialWords() {
    patterns.length = 0;
    initialWords.forEach(word => {
      const { steps, unknown } = wordToSteps(word);
      if (unknown.length > 0) {
        // 未対応文字を含む場合はスキップ（必要ならコンソールに出して確認）
        console.warn("未対応文字を含むためスキップ:", word, "unknown:", unknown);
        return;
      }
      if (steps.length === 0) return;
      patterns.push({
        id: Date.now() + "_" + Math.random().toString(16).slice(2),
        word,
        steps
      });
    });
    updateWordList();
  }

  // ---- 練習ロジック ----
  function setMode(newMode) {
    mode = newMode;
  }

  function resetPracticeView() {
    currentWordEl.textContent = "（まだ出題されていません）";
    stepProgressEl.textContent = "";
    guideTextEl.textContent = "";
    practiceStatusEl.textContent = "";
    practiceStatusEl.className = "status";
    practiceStepsArea.textContent = "（出題中のみ表示されます）";
    highlightGuideKey(null);
    stopPracticeBtn.disabled = true;
  }

  function startRandomPractice() {
    if (patterns.length === 0) return;
    const idx = Math.floor(Math.random() * patterns.length);
    currentPattern = patterns[idx];
    currentStepIndex = 0;
    setMode(MODE_PRACTICE);

    stopPracticeBtn.disabled = false;

    currentWordEl.textContent = "問題：「" + currentPattern.word + "」";
    practiceStatusEl.textContent = "ガイドにしたがってフリックしてください。";
    practiceStatusEl.className = "status";
    renderPracticeSteps();
    showCurrentGuide();
  }

  function renderPracticeSteps() {
    if (!currentPattern) {
      practiceStepsArea.textContent = "（出題中のみ表示されます）";
      return;
    }
    const steps = currentPattern.steps;
    practiceStepsArea.innerHTML = "";
    steps.forEach((step, idx) => {
      const span = document.createElement("span");
      span.className = "pattern-step";
      let mark = "";
      if (idx === currentStepIndex) mark = " ▶";
      if (idx < currentStepIndex) mark = " ✓";

      span.textContent =
        (idx + 1) + ": 「" + step.char + "」→" +
        getKeyLabel(step.keyId) + " " + dirText[step.direction] + mark;
      practiceStepsArea.appendChild(span);
    });
    stepProgressEl.textContent =
      "進捗：" + (currentStepIndex + 1) + " / " + steps.length;
  }

// ★変更後：キー枠＋矢印の両方をガイド表示（方向ズラし対応）
  function highlightGuideKey(keyId, direction = null) {
    // 全キーの guide クラスをリセット
    keyElements.forEach(k => {
      k.classList.remove("guide", "guide-up", "guide-down", "guide-left", "guide-right", "guide-center");
    });

    // 矢印強調を更新
    updateAllKeyArrows(keyId, direction);

    if (!keyId) return;

    const el = keyElements.find(k => k.dataset.keyId === keyId);
    if (!el) return;

    // 基本の青枠
    el.classList.add("guide");

    // ★方向に応じてズラすクラスを付与
    switch (direction) {
      case "up":    el.classList.add("guide-up"); break;
      case "down":  el.classList.add("guide-down"); break;
      case "left":  el.classList.add("guide-left"); break;
      case "right": el.classList.add("guide-right"); break;
      case "center": el.classList.add("guide-center"); break;
    }
        }

  function showCurrentGuide() {
    if (!currentPattern) {
      guideTextEl.textContent = "";
      highlightGuideKey(null, null);
      return;
    }
    const steps = currentPattern.steps;
    if (currentStepIndex >= steps.length) {
      guideTextEl.textContent = "全てのステップを完了しました。";
      highlightGuideKey(null, null);
      return;
    }
    const step = steps[currentStepIndex];
    highlightGuideKey(step.keyId, step.direction);
    guideTextEl.textContent =
      "ガイド：" +
      "「" + step.char + "」＝「" +
      getKeyLabel(step.keyId, step.direction) + "」を「" +
      dirText[step.direction] + "」";
    renderPracticeSteps();
  }

  function onCorrectStep() {
    if (!currentPattern) return;
    const total = currentPattern.steps.length;
    currentStepIndex++;
    if (currentStepIndex >= total) {
      practiceStatusEl.textContent =
        "正解！全てのステップを再現できました。";
      practiceStatusEl.className = "status ok";
      stepProgressEl.textContent = "進捗：" + total + " / " + total;
      guideTextEl.textContent =
        "お疲れさまでした。「ランダムに出題」を押すと次の問題に進みます。";
      highlightGuideKey(null);
    } else {
      practiceStatusEl.textContent = "OK！次のステップへ。";
      practiceStatusEl.className = "status ok";
      showCurrentGuide();
    }
  }

  function onWrongStep() {
    if (!currentPattern) return;
    const expected = currentPattern.steps[currentStepIndex];
    practiceStatusEl.textContent =
      "違います。 ガイドの通りに「" +
      getKeyLabel(expected.keyId) + "」を「" +
      dirText[expected.direction] + "」してください。";
    practiceStatusEl.className = "status ng";
  }

  startPracticeBtn.addEventListener("click", () => {
    startRandomPractice();
  });

  stopPracticeBtn.addEventListener("click", () => {
    setMode(MODE_IDLE);
    resetPracticeView();
    practiceStatusEl.textContent = "練習を終了しました。";
  });

  // ---- 擬似キーボード：フリック検知 ----
  function getDirectionFromDelta(dx, dy) {
    const threshold = 20; // 「矢印から外にスライド」くらいの距離
    const distSq = dx * dx + dy * dy;
    if (distSq < threshold * threshold) return "center";
    if (Math.abs(dx) > Math.abs(dy)) {
      return dx > 0 ? "right" : "left";
    } else {
      return dy > 0 ? "down" : "up";
    }
  }

  keyElements.forEach(keyEl => {
    keyEl.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      const keyId = keyEl.dataset.keyId;
      pointerState = {
        id: e.pointerId,
        keyId,
        startX: e.clientX,
        startY: e.clientY
      };
      keyEl.setPointerCapture(e.pointerId);
    });

    keyEl.addEventListener("pointerup", (e) => {
      if (!pointerState || pointerState.id !== e.pointerId) return;
      const dx = e.clientX - pointerState.startX;
      const dy = e.clientY - pointerState.startY;
      const direction = getDirectionFromDelta(dx, dy);
      const keyId = pointerState.keyId;
      keyEl.releasePointerCapture(e.pointerId);
      pointerState = null;
      handleFlick(keyId, direction);
    });

    keyEl.addEventListener("pointercancel", () => {
      pointerState = null;
    });
  });

  function handleFlick(keyId, direction) {
    // space / del は無視
    if (keyId === "space" || keyId === "del") return;
    if (mode !== MODE_PRACTICE || !currentPattern) return;

    const expected = currentPattern.steps[currentStepIndex];
    if (!expected) return;

    if (expected.keyId === keyId && expected.direction === direction) {
      onCorrectStep();
    } else {
      onWrongStep();
    }
  }

  // ---- 初期化 ----
  renderMappingTable();
  initPatternsFromInitialWords();
  resetPracticeView();
  if (patterns.length > 0) {
    practiceStatusEl.textContent = "「ランダムに出題」を押して練習を始めてください。";
  }
})();
</script>
</body>
</html>
