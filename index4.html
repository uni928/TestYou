
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>コードリーダー（メソッドジャンプ付き）</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, sans-serif;
      background: #f3f3f3;
      color: #222;
    }

    header {
      padding: 12px 16px;
      background: #333;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 18px;
      margin: 0;
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      height: calc(100vh - 56px);
      box-sizing: border-box;
    }

    .panel {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 8px;
    }

    #inputPanel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 35vh;
    }

    #viewPanel {
      flex: 1;
      overflow: auto;
      background: #1e1e1e;
      color: #ddd;
      font-family: "SF Mono", Consolas, monospace;
      min-height: 90vh;
    }

    textarea {
      width: 100%;
      height: 100%;
      resize: none;
      padding: 8px;
      font-family: inherit;
      font-size: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #codeContent {
      padding: 8px;
      box-sizing: border-box;
      font-size: 20px;
      line-height: 1.5;
      white-space: pre;
    }

    .code-line {
      display: flex;
    }
    .line-number {
      width: 3em;
      padding-right: 8px;
      text-align: right;
      color: #777;
      user-select: none;
    }
    .code-text {
      flex: 1;
      white-space: pre-wrap;
    }

    .code-token.call {
      text-decoration: underline;
      color: #4ea1ff;
      cursor: pointer;
    }
    .code-token.decl {
      color: #9cdcfe;
      font-weight: bold;
    }

    .decl-highlight {
      background: rgba(255,255,0,0.18);
      transition: background 0.4s;
    }
    .call-highlight {
      background: rgba(76,175,80,0.25);
      transition: background 0.4s;
      border-radius: 2px;
    }

    /* ======================================================
       ★★ 右下に大きい戻るボタン（レスポンシブ対応） ★★
       横幅 = 400px または 画面横幅の1/3 の小さい方
       高さ = ボタン幅の 1/4 で“良い感じ”
    ====================================================== */
    #backButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2000;

      width: min(400px, 33vw);
      height: calc(min(400px, 33vw) / 4);

      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: calc(min(400px, 33vw) / 10);
      font-weight: bold;

      display: flex;
      justify-content: center;
      align-items: center;

      box-shadow: 0 6px 15px rgba(0,0,0,0.25);
      cursor: pointer;

      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    #backButton:active {
      transform: scale(0.95);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    #info {
      font-size: 11px;
      color: #555;
    }

/* ▼ 宣言ジャンプ済みメソッドにつく緑丸チェックアイコン */
.method-checked::after {
  content: "";
  display: inline-block;
  width: 15px;
  height: 15px;
  margin-left: 4px;
  vertical-align: middle;

  /* SVG の Base64。緑色の丸に白のチェック */
  background-image: url('data:image/svg+xml;base64,PHN2ZyBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMiIgdmlld0JveD0iMCAwIDI0IDI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBmaWxsPSIjMjJjNTVlIi8+PHBhdGggc3Ryb2tlPSIjZmZmIiBkPSJNOC4yIDExLjkgMTEgMTQgMTYuMiA5Ii8+PC9zdmc+');
  background-size: contain;
  background-repeat: no-repeat;
}

/* ▼ 追加：ヘッダー左側（タイトル＋サブタイトル） */
.header-left {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

/* ▼ 追加：サブタイトル用 */
.header-subtitle {
  font-size: 12px;
  opacity: 0.8;
}

/* ▼ 追加：右上のファイルドロップ＆選択パネル */
#fileDropArea {
  position: relative;
  min-width: 220px;
  max-width: 280px;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px dashed rgba(255, 255, 255, 0.6);
  background: rgba(0, 0, 0, 0.15);
  font-size: 11px;
  color: #f9fafb;
  cursor: pointer;
  text-align: center;
}

/* ドラッグ中の強調表示 */
#fileDropArea.dragover {
  background: rgba(37, 99, 235, 0.4);
  border-style: solid;
}

/* ボタン風ラベル */
.file-drop-label {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 2px;
}

/* 補足説明 */
.file-drop-hint {
  font-size: 10px;
  opacity: 0.9;
}

/* 実際の input[type=file] は隠す */
#fileInput {
  display: none;
}

/* ▼ チェックボックスのテキストが見やすくなる */
#rightClickReturn {
  vertical-align: middle;
  margin-right: 4px;
}

/* ▼ スマホ & タブレット（タッチ端末）では非表示 */
@media (hover: none) and (pointer: coarse) {
  .rightclick-option {
    display: none !important;
  }
}

  </style>
</head>
<body>

<header>
  <div class="header-left">
    <h1>コードリーダー（メソッド宣言ジャンプ対応）</h1>
    <div class="header-subtitle">宣言へジャンプ／戻るで呼び出しへ</div>
  </div>
<!-- ▼ 右クリック戻るオプション（PC のみ表示） -->
<div class="rightclick-option" style="margin-left: 16px; font-size: 12px; color: #fff;">
  <label style="cursor: pointer;">
    <input type="checkbox" id="rightClickReturn" checked>
    右クリックで呼び出しに戻る
  </label>
</div>
  <!-- ▼ 追加：画面右上のファイルドロップ＆選択パネル -->
  <div id="fileDropArea">
    <div class="file-drop-label">ファイルからコードを追加</div>
    <div class="file-drop-hint">
      ここにドラッグ＆ドロップ<br>
      またはクリックして選択
    </div>
    <input type="file" id="fileInput" multiple>
  </div>

</header>

<main>
  <section id="inputPanel" class="panel">
    <strong>コード入力</strong>
    <div id="info">
      宣言があるメソッド呼び出しだけがリンクになります。
    </div>

    <div style="display:flex; gap:6px;">
      <button id="analyzeButton">解析して表示</button>
      <button id="sampleButton" class="secondary">サンプルコード</button>
    </div>

    <textarea id="codeInput" placeholder="ここにコードを貼り付けて、上部の「解析して表示」ボタンを押して下さい。"></textarea>
  </section>

  <section id="viewPanel" class="panel">
    <div id="codeContent"></div>
  </section>
</main>

<button id="backButton" hidden>⬅ 呼び出しに戻る</button>

<script>
/* === （中略せずすべて含めます：前バージョンと同じ） === */
/* ========= 以降はそのままのロジック（全文） ========= */

const codeInput = document.getElementById("codeInput");
const codeContent = document.getElementById("codeContent");
const analyzeButton = document.getElementById("analyzeButton");
const sampleButton = document.getElementById("sampleButton");
const backButton = document.getElementById("backButton");
// ▼ 追加：ファイルドロップ／選択用の要素
const fileDropArea = document.getElementById("fileDropArea");
const fileInput = document.getElementById("fileInput");

// ▼ 追加：右クリック戻るの ON/OFF チェックボックス
const rightClickReturn = document.getElementById("rightClickReturn");

let scrollHistory = [];
let currentHighlightLine = null;
let currentCallHighlight = null;

function escapeHtml(str) {
  return str.replace(/&/g,"&amp;")
            .replace(/</g,"&lt;")
            .replace(/>/g,"&gt;")
            .replace(/"/g,"&quot;")
            .replace(/'/g,"&#39;");
}

function detectDeclarations(lines) {
  const declInfoPerLine = new Array(lines.length);
  const declarations = {};

  lines.forEach((line, index) => {
    let m;
    let name = null;

    const js = /^\s*(?:async\s+)?function\s+([A-Za-z_]\w*)\s*\(/;
    if ((m = js.exec(line))) name = m[1];

    if (!name) {
      const cLike = /^\s*(?:[A-Za-z_][\w<>\[\]\s\*]+)\s+([A-Za-z_]\w*)\s*\(/;
      if ((m = cLike.exec(line))) name = m[1];
    }

    if (name) {
      const id = `decl-${name}-${index+1}`;
      declInfoPerLine[index] = { name, id };
      if (!declarations[name]) declarations[name] = [];
      declarations[name].push(id);
    }
  });
  return { declInfoPerLine, declarations };
}

function buildCodeView(codeText) {
  codeContent.innerHTML = "";
  scrollHistory = [];
  backButton.hidden = true;

  const lines = codeText.replace(/\t/g,"    ").split("\n");
  const { declInfoPerLine, declarations } = detectDeclarations(lines);

  let callIdCounter = 0;

  lines.forEach((raw, index) => {
    const esc = escapeHtml(raw);

    const lineDiv = document.createElement("div");
    lineDiv.className = "code-line";
    lineDiv.dataset.line = index+1;

    const numSpan = document.createElement("span");
    numSpan.className = "line-number";
    numSpan.textContent = String(index+1).padStart(3," ");

    const codeSpan = document.createElement("span");
    codeSpan.className = "code-text";

    const declInfo = declInfoPerLine[index];
    let html = "";
    let last = 0;
    let m;
    const re = /(\b[A-Za-z_]\w*)(\s*\()/g;

    while ((m = re.exec(esc)) !== null) {
      const name = m[1];
      const after = m[2];
      const s = m.index;
      const e = re.lastIndex;

      html += esc.slice(last, s);

      const hasDecl = declarations[name]?.length > 0;

      if (declInfo && declInfo.name === name) {
        html += `<span class="code-token decl" id="${declInfo.id}">${name}</span>${after}`;
      } else if (hasDecl) {
        const callId = `call-${callIdCounter++}`;
        html += `<span class="code-token call" id="${callId}" data-target="${declarations[name][0]}">${name}</span>${after}`;
      } else {
        html += `${name}${after}`;
      }

      last = e;
    }
    html += esc.slice(last);

    codeSpan.innerHTML = html;

    lineDiv.appendChild(numSpan);
    lineDiv.appendChild(codeSpan);
    codeContent.appendChild(lineDiv);
  });

  document.querySelectorAll(".code-token.call").forEach(el => {
    el.addEventListener("click", () => {
      jumpToDeclaration(el.dataset.target, el.id);
    });
  });
}

// ▼ 追加：選択／ドロップされたファイルを順に末尾へ追加する
function appendFilesToEditor(fileList) {
  const files = Array.from(fileList);
  if (files.length === 0) return;

  const appendNext = (index) => {
    if (index >= files.length) return;

    const file = files[index];
    const reader = new FileReader();

    reader.onload = (e) => {
      const text = e.target.result ?? "";

      // 既にテキストがあって末尾が改行で終わっていなければ改行を追加
      if (codeInput.value && !codeInput.value.endsWith("\n")) {
        codeInput.value += "\n";
      }

      // ファイル名コメントを挿入してから中身を追加（不要ならコメント行を削除可）
      codeInput.value += `// ===== ${file.name} =====\n`;
      codeInput.value += text + "\n";

      appendNext(index + 1);
    };

    reader.onerror = () => {
      // 読み込み失敗時も次へ
      appendNext(index + 1);
    };

    reader.readAsText(file);
  };

  appendNext(0);
}


function selectElementContents(el) {
  const r = document.createRange();
  r.selectNodeContents(el);
  const s = window.getSelection();
  s.removeAllRanges();
  s.addRange(r);
}

function jumpToDeclaration(targetId, callId) {
  const target = document.getElementById(targetId);
  if (!target) return;

  // 現在のスクロール位置と「押した呼び出し元ID」を履歴に保存
  const scrollY = window.scrollY || document.documentElement.scrollTop;
  scrollHistory.push({ scrollY, callId });
  backButton.hidden = false;

  // 以前のハイライトを解除
  if (currentHighlightLine) {
    currentHighlightLine.classList.remove("decl-highlight");
    currentHighlightLine = null;
  }
  if (currentCallHighlight) {
    currentCallHighlight.classList.remove("call-highlight");
    currentCallHighlight = null;
  }

  // 宣言行の DOM（.code-line 単位）を取得
  const lineEl = target.closest(".code-line") || target;

  // 宣言行全体を選択
  selectElementContents(lineEl);

  // 宣言行までスクロール（中央あたりに表示）
  lineEl.scrollIntoView({ behavior: "smooth", block: "center" });

  // 宣言行をハイライト
  lineEl.classList.add("decl-highlight");
  currentHighlightLine = lineEl;

  // ★ 呼び出し先（宣言側のメソッド名）にチェックを付与
  target.classList.add("method-checked");

  // ★ この宣言をターゲットにしている全ての呼び出し元にもチェックを付与
  // buildCodeView 内で .call に data-target="${declarations[name][0]}" を付けている前提
  const relatedCalls = document.querySelectorAll(
    `.code-token.call[data-target="${targetId}"]`
  );
  relatedCalls.forEach(callEl => {
    callEl.classList.add("method-checked");
  });
}




function goBack() {
  if (scrollHistory.length === 0) {
    backButton.hidden = true;
    return;
  }

  const entry = scrollHistory.pop();
  const callEl = document.getElementById(entry.callId);

  if (currentHighlightLine) currentHighlightLine.classList.remove("decl-highlight");
  if (currentCallHighlight) currentCallHighlight.classList.remove("call-highlight");

  if (callEl) {
    selectElementContents(callEl);
    callEl.classList.add("call-highlight");
    currentCallHighlight = callEl;

    callEl.scrollIntoView({ behavior: "smooth", block: "center" });
  } else {
    window.scrollTo({ top: entry.scrollY, behavior: "smooth" });
  }

  if (scrollHistory.length === 0) backButton.hidden = true;
}

analyzeButton.addEventListener("click", () => {
  buildCodeView(codeInput.value);
});

backButton.addEventListener("click", goBack);

sampleButton.addEventListener("click", () => {
  const sample = `function add(a,b){ return a+b; }
function mul(a,b){ return a*b; }
function calc(x,y){ return add(x,y) + mul(x,y) + unknown(x,y); }`;
  codeInput.value = sample;
  buildCodeView(sample);
});

// ▼ 追加：ドロップエリアをクリックしたらファイル選択ダイアログを開く
fileDropArea.addEventListener("click", () => {
  fileInput.click();
});

// ▼ 追加：input[type=file] でファイルが選択されたとき
fileInput.addEventListener("change", (e) => {
  const files = e.target.files;
  if (files && files.length > 0) {
    appendFilesToEditor(files);
  }
  // 同じファイルを連続選択できるようにリセット
  fileInput.value = "";
});

// ▼ 追加：ドラッグオーバー時の見た目変更＆ドロップ許可
fileDropArea.addEventListener("dragover", (e) => {
  e.preventDefault();
  e.stopPropagation();
  fileDropArea.classList.add("dragover");
});

fileDropArea.addEventListener("dragleave", (e) => {
  e.preventDefault();
  e.stopPropagation();
  fileDropArea.classList.remove("dragover");
});

fileDropArea.addEventListener("drop", (e) => {
  e.preventDefault();
  e.stopPropagation();
  fileDropArea.classList.remove("dragover");

  const files = e.dataTransfer?.files;
  if (files && files.length > 0) {
    appendFilesToEditor(files);
  }
});

// ▼ 修正：チェックボックスが ON のときだけ右クリックで戻る
document.addEventListener("mousedown", (e) => {
  if (e.button === 2) {
    if (rightClickReturn.checked) {
      e.preventDefault(); // 右クリックメニューを出さない
      goBack();
    }
  }
});

// ▼ 修正：右クリック戻りが ON のときだけ右クリックメニューを無効化
document.addEventListener("contextmenu", (e) => {
  if (rightClickReturn.checked) {
    e.preventDefault();
  }
});

window.addEventListener("DOMContentLoaded", () => {
  //sampleButton.click();
});

// ▼ タッチ端末（スマホ・タブレット）は常に OFF
if (matchMedia("(hover: none) and (pointer: coarse)").matches) {
  const rightClickReturn = document.getElementById("rightClickReturn");
  if (rightClickReturn) {
    rightClickReturn.checked = false;
  }
}
</script>

</body>
</html>
